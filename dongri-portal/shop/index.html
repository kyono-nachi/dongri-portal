<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>SHOP - DonGri PORTAL</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=Oswald:wght@400;600;700&family=Anton&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Georgia', serif;
            background: linear-gradient(135deg, #1a0000 0%, #000000 50%, #1a0000 100%);
            color: #fff;
            min-height: 100vh;
            padding: 20px;
            overflow-x: hidden;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        /* ãƒ˜ãƒƒãƒ€ãƒ¼ */
        .header {
            text-align: center;
            margin-bottom: 40px;
            padding: 30px 0;
            border-bottom: 2px solid #d4af37;
        }

        .header h1 {
            font-family: 'Bebas Neue', sans-serif;
            font-size: 3.5em;
            color: #d4af37;
            text-shadow: 0 0 30px rgba(212, 175, 55, 0.8);
            letter-spacing: 8px;
            margin-bottom: 10px;
        }

        .header .subtitle {
            font-size: 1.2em;
            color: #f4e5b0;
            letter-spacing: 3px;
        }

        /* æ®‹é«˜è¡¨ç¤º */
        .balance-display {
            text-align: center;
            padding: 20px;
            background: rgba(212, 175, 55, 0.1);
            border-radius: 15px;
            margin-bottom: 30px;
            border: 2px solid rgba(212, 175, 55, 0.3);
        }

        .balance-display .label {
            font-size: 1em;
            color: #aaa;
            margin-bottom: 5px;
        }

        .balance-display .amount {
            font-family: 'Bebas Neue', sans-serif;
            font-size: 2.5em;
            color: #d4af37;
            text-shadow: 0 0 20px rgba(212, 175, 55, 0.6);
        }

        /* ã‚«ãƒ¼ãƒ‰ */
        .card {
            background: rgba(0, 0, 0, 0.8);
            border: 2px solid #d4af37;
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 0 30px rgba(212, 175, 55, 0.3);
        }

        .card h2 {
            font-family: 'Bebas Neue', sans-serif;
            color: #d4af37;
            font-size: 2em;
            margin-bottom: 20px;
            text-align: center;
        }

        /* å•†å“ã‚°ãƒªãƒƒãƒ‰ */
        .products-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
            justify-items: center;
            max-width: 1200px;
            margin-left: auto;
            margin-right: auto;
        }

        .product-item {
            background: rgba(255, 255, 255, 0.05);
            border: 2px solid rgba(212, 175, 55, 0.3);
            border-radius: 15px;
            padding: 20px;
            text-align: center;
            transition: all 0.3s;
            width: 280px;
            max-width: 100%;
        }

        .product-item:hover {
            border-color: #d4af37;
            box-shadow: 0 0 20px rgba(212, 175, 55, 0.4);
            transform: translateY(-5px);
        }

        .product-icon {
            font-size: 3em;
            margin-bottom: 15px;
        }

        .product-name {
            font-size: 1.2em;
            font-weight: bold;
            color: #fff;
            margin-bottom: 10px;
        }

        .product-description {
            font-size: 0.9em;
            color: #aaa;
            margin-bottom: 15px;
            line-height: 1.5;
        }

        .product-price {
            font-family: 'Bebas Neue', sans-serif;
            font-size: 2em;
            color: #d4af37;
            margin-bottom: 15px;
        }

        .product-category {
            display: inline-block;
            padding: 5px 10px;
            background: rgba(212, 175, 55, 0.2);
            border-radius: 5px;
            font-size: 0.8em;
            color: #d4af37;
            margin-bottom: 15px;
        }

        /* ãƒœã‚¿ãƒ³ */
        .btn {
            display: inline-block;
            padding: 12px 24px;
            font-size: 0.9em;
            font-weight: bold;
            font-family: 'Oswald', sans-serif;
            background: linear-gradient(135deg, #d4af37 0%, #f4e5b0 50%, #d4af37 100%);
            color: #000;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            margin: 5px;
            transition: all 0.3s;
            text-transform: uppercase;
            letter-spacing: 2px;
            box-shadow: 0 5px 15px rgba(212, 175, 55, 0.4);
            text-decoration: none;
            text-align: center;
        }

        .btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(212, 175, 55, 0.6);
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .btn-secondary {
            background: rgba(212, 175, 55, 0.05);
            color: #d4af37;
            border: 2px solid #d4af37;
            padding: 10px 20px;
            box-shadow: none;
        }

        .btn-small {
            padding: 8px 16px;
            font-size: 0.85em;
        }

        /* è³¼å…¥å±¥æ­´ */
        .order-list {
            max-height: 300px;
            overflow-y: auto;
        }

        .order-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 8px;
            margin-bottom: 8px;
            border-left: 3px solid #d4af37;
        }

        .order-date {
            font-size: 0.85em;
            color: #aaa;
        }

        .order-product {
            font-size: 1em;
            color: #fff;
            font-weight: bold;
        }

        .order-price {
            font-family: 'Bebas Neue', sans-serif;
            font-size: 1.2em;
            color: #f44336;
        }

        /* æ‰€æŒã‚¢ã‚¤ãƒ†ãƒ è¡¨ç¤º */
        .items-display {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            margin-bottom: 20px;
            padding: 15px;
            background: rgba(212, 175, 55, 0.05);
            border-radius: 10px;
        }

        .item-badge {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 15px;
            background: rgba(212, 175, 55, 0.2);
            border: 1px solid #d4af37;
            border-radius: 20px;
            font-size: 0.9em;
        }

        .item-icon {
            font-size: 1.2em;
        }

        .item-quantity {
            font-family: 'Bebas Neue', sans-serif;
            color: #d4af37;
            font-size: 1.1em;
        }

        .loading {
            text-align: center;
            color: #d4af37;
            padding: 20px;
        }

        .empty-message {
            text-align: center;
            color: #888;
            padding: 40px;
            font-size: 1.1em;
        }

        .back-button {
            text-align: center;
            margin-top: 30px;
        }

        /* ãƒ¢ãƒ¼ãƒ€ãƒ« */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            z-index: 1000;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: rgba(0, 0, 0, 0.95);
            border: 3px solid #d4af37;
            border-radius: 20px;
            padding: 40px;
            max-width: 500px;
            width: 100%;
            box-shadow: 0 0 50px rgba(212, 175, 55, 0.5);
            text-align: center;
        }

        .modal-content h2 {
            font-family: 'Bebas Neue', sans-serif;
            color: #d4af37;
            font-size: 2em;
            margin-bottom: 20px;
        }

        /* ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ– */
        @media (max-width: 768px) {
            .header h1 {
                font-size: 2.5em;
            }

            .products-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- ãƒ˜ãƒƒãƒ€ãƒ¼ -->
        <div class="header">
            <h1>ğŸ SHOP</h1>
            <div class="subtitle">Exchange Your DNG</div>
        </div>

        <!-- æ®‹é«˜è¡¨ç¤º -->
        <div class="balance-display">
            <div class="label">ç¾åœ¨ã®æ®‹é«˜</div>
            <div class="amount" id="currentBalance">0</div>
            <div class="label">DNG</div>
            <button class="btn btn-small" onclick="refreshShopData()" style="margin-top: 15px; background: rgba(212, 175, 55, 0.05); color: #d4af37; border: 2px solid #d4af37; padding: 8px 16px; box-shadow: none; font-size: 0.85em;">
                ğŸ”„ æ®‹é«˜ã‚’æ›´æ–°
            </button>
        </div>

        <!-- æ‰€æŒã‚¢ã‚¤ãƒ†ãƒ è¡¨ç¤º -->
        <div class="card">
            <h2>ğŸ’ æ‰€æŒã‚¢ã‚¤ãƒ†ãƒ </h2>
            <div id="itemsDisplay" class="items-display">
                <div class="loading">èª­ã¿è¾¼ã¿ä¸­...</div>
            </div>
        </div>

        <!-- å•†å“ä¸€è¦§ -->
        <div class="card">
            <h2>ğŸ“¦ å•†å“ä¸€è¦§</h2>
            <div id="productsGrid" class="products-grid">
                <div class="loading">èª­ã¿è¾¼ã¿ä¸­...</div>
            </div>
        </div>

        <!-- è³¼å…¥å±¥æ­´ -->
        <div class="card">
            <h2>ğŸ“œ è³¼å…¥å±¥æ­´</h2>
            <div id="orderList" class="order-list">
                <div class="loading">èª­ã¿è¾¼ã¿ä¸­...</div>
            </div>
        </div>

        <!-- æˆ»ã‚‹ãƒœã‚¿ãƒ³ -->
        <div class="back-button">
            <a href="/" class="btn btn-secondary">â† ãƒãƒ¼ã‚¿ãƒ«ã«æˆ»ã‚‹</a>
        </div>
    </div>

    <!-- è³¼å…¥ç¢ºèªãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div class="modal" id="purchaseModal">
        <div class="modal-content">
            <h2>è³¼å…¥ç¢ºèª</h2>
            <div id="purchaseDetails" style="margin: 20px 0; line-height: 1.8;"></div>
            <div id="purchaseLoading" style="display: none; text-align: center; margin: 20px 0; color: #d4af37;">
                <div style="font-size: 2em; margin-bottom: 10px;">â³</div>
                <div>å‡¦ç†ä¸­...</div>
            </div>
            <button class="btn" id="confirmPurchaseBtn" onclick="confirmPurchase()">è³¼å…¥ã™ã‚‹</button>
            <button class="btn btn-secondary" id="cancelPurchaseBtn" onclick="closePurchaseModal()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
        </div>
    </div>

    <script>
        // API URL
        const API_URL = 'https://script.google.com/macros/s/AKfycbyFxDv-KWnawfsrC2Kl82Gavo_s0ZGqEA4zrPPc3LVY9S3FuL_dC7QgkYv5hMeeiQo8/exec';
        
        let currentUser = null;
        let selectedProduct = null;

        // åˆæœŸåŒ–
        window.addEventListener('DOMContentLoaded', function() {
            const uniqueID = localStorage.getItem('playerUniqueID');
            const displayName = localStorage.getItem('displayName');

            if (!uniqueID || !displayName) {
                alert('ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ãã ã•ã„');
                window.location.href = '/';
                return;
            }

            currentUser = { uniqueID, displayName };
            loadShopData();
        });

        // ã‚·ãƒ§ãƒƒãƒ—ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿
        async function loadShopData() {
            try {
                // æ®‹é«˜å–å¾—
                const balanceResult = await callAPI('getBalance', { uniqueID: currentUser.uniqueID });
                if (balanceResult.success) {
                    document.getElementById('currentBalance').textContent = balanceResult.data.balance.toLocaleString();
                }

                // æ‰€æŒã‚¢ã‚¤ãƒ†ãƒ å–å¾—
                const itemsResult = await callAPI('getUserItems', { uniqueID: currentUser.uniqueID });
                if (itemsResult.success) {
                    displayUserItems(itemsResult.data.items);
                }

                // å•†å“ä¸€è¦§å–å¾—
                const productsResult = await callAPI('getProducts', {});
                if (productsResult.success) {
                    displayProducts(productsResult.data.products);
                }

                // è³¼å…¥å±¥æ­´å–å¾—
                const ordersResult = await callAPI('getPurchaseHistory', { uniqueID: currentUser.uniqueID });
                if (ordersResult.success) {
                    displayOrders(ordersResult.data.orders);
                }
            } catch (error) {
                console.error('Error loading shop data:', error);
            }
        }

        // æ‰‹å‹•æ›´æ–°ï¼ˆãƒœã‚¿ãƒ³ç”¨ï¼‰
        async function refreshShopData() {
            const btn = event.target;
            btn.disabled = true;
            btn.textContent = 'â³ æ›´æ–°ä¸­...';
            
            await loadShopData();
            
            btn.disabled = false;
            btn.innerHTML = 'ğŸ”„ æ®‹é«˜ã‚’æ›´æ–°';
            
            // ä¸€æ™‚çš„ã«å®Œäº†è¡¨ç¤º
            btn.innerHTML = 'âœ“ æ›´æ–°å®Œäº†';
            setTimeout(() => {
                btn.innerHTML = 'ğŸ”„ æ®‹é«˜ã‚’æ›´æ–°';
            }, 2000);
        }

        // æ‰€æŒã‚¢ã‚¤ãƒ†ãƒ è¡¨ç¤º
        function displayUserItems(items) {
            const itemsDisplay = document.getElementById('itemsDisplay');
            
            if (!items || items.length === 0) {
                itemsDisplay.innerHTML = '<div class="empty-message">æ‰€æŒã‚¢ã‚¤ãƒ†ãƒ ã¯ã‚ã‚Šã¾ã›ã‚“</div>';
                return;
            }

            let html = '';
            items.forEach(item => {
                const icon = getItemIcon(item.itemType);
                const name = getItemName(item.itemType, item.itemID);
                html += `
                    <div class="item-badge">
                        <span class="item-icon">${icon}</span>
                        <span>${name}</span>
                        <span class="item-quantity">Ã—${item.quantity}</span>
                    </div>
                `;
            });
            
            itemsDisplay.innerHTML = html;
        }

        // ã‚¢ã‚¤ãƒ†ãƒ ã‚¢ã‚¤ã‚³ãƒ³å–å¾—
        function getItemIcon(itemType) {
            const icons = {
                'ticket': 'ğŸ«',
                'badge': 'ğŸ†',
                'title': 'ğŸ‘‘',
                'digital': 'ğŸ–¼ï¸',
                'game_bonus': 'â­'
            };
            return icons[itemType] || 'ğŸ“¦';
        }

        // ã‚¢ã‚¤ãƒ†ãƒ åå–å¾—
        function getItemName(itemType, itemID) {
            if (itemType === 'ticket' && itemID === 'card_design') {
                return 'ã‚«ãƒ¼ãƒ‰ãƒ‡ã‚¶ã‚¤ãƒ³ãƒã‚±ãƒƒãƒˆ';
            }
            return itemID;
        }

        // å•†å“ä¸€è¦§è¡¨ç¤º
        function displayProducts(products) {
            const productsGrid = document.getElementById('productsGrid');
            
            if (!products || products.length === 0) {
                productsGrid.innerHTML = '<div class="empty-message">å•†å“ãŒã‚ã‚Šã¾ã›ã‚“</div>';
                return;
            }

            let html = '';
            products.forEach(product => {
                const icon = getCategoryIcon(product.category);
                html += `
                    <div class="product-item">
                        <div class="product-icon">${icon}</div>
                        <div class="product-category">${getCategoryName(product.category)}</div>
                        <div class="product-name">${product.productName}</div>
                        <div class="product-description">${product.description}</div>
                        <div class="product-price">${product.price.toLocaleString()} DNG</div>
                        <button class="btn btn-small" onclick='openPurchaseModal(${JSON.stringify(product)})'>è³¼å…¥</button>
                    </div>
                `;
            });
            
            productsGrid.innerHTML = html;
        }

        // ã‚«ãƒ†ã‚´ãƒªã‚¢ã‚¤ã‚³ãƒ³å–å¾—
        function getCategoryIcon(category) {
            const icons = {
                'ticket': 'ğŸ«',
                'digital': 'ğŸ–¼ï¸',
                'badge': 'ğŸ†',
                'game_bonus': 'â­',
                'title': 'ğŸ‘‘'
            };
            return icons[category] || 'ğŸ';
        }

        // ã‚«ãƒ†ã‚´ãƒªåå–å¾—
        function getCategoryName(category) {
            const names = {
                'ticket': 'ãƒã‚±ãƒƒãƒˆ',
                'digital': 'ãƒ‡ã‚¸ã‚¿ãƒ«ç‰¹å…¸',
                'badge': 'ãƒãƒƒã‚¸',
                'game_bonus': 'ã‚²ãƒ¼ãƒ ç‰¹å…¸',
                'title': 'ç§°å·'
            };
            return names[category] || 'ãã®ä»–';
        }

        // è³¼å…¥å±¥æ­´è¡¨ç¤º
        function displayOrders(orders) {
            const orderList = document.getElementById('orderList');
            
            if (!orders || orders.length === 0) {
                orderList.innerHTML = '<div class="empty-message">è³¼å…¥å±¥æ­´ãŒã‚ã‚Šã¾ã›ã‚“</div>';
                return;
            }

            let html = '';
            orders.forEach(order => {
                html += `
                    <div class="order-item">
                        <div>
                            <div class="order-date">${formatDate(order.timestamp)}</div>
                            <div class="order-product">${order.productName}</div>
                        </div>
                        <div class="order-price">-${order.price.toLocaleString()} DNG</div>
                    </div>
                `;
            });
            
            orderList.innerHTML = html;
        }

        // è³¼å…¥ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‹ã
        function openPurchaseModal(product) {
            selectedProduct = product;
            const details = `
                <p><strong>${product.productName}</strong></p>
                <p style="color: #aaa; font-size: 0.9em;">${product.description}</p>
                <p style="margin-top: 15px; font-size: 1.5em; color: #d4af37;"><strong>${product.price.toLocaleString()} DNG</strong></p>
                <p style="color: #aaa; font-size: 0.85em; margin-top: 10px;">ã“ã®å•†å“ã‚’è³¼å…¥ã—ã¾ã™ã‹?</p>
            `;
            document.getElementById('purchaseDetails').innerHTML = details;
            document.getElementById('purchaseModal').classList.add('active');
        }

        // è³¼å…¥ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
        function closePurchaseModal() {
            document.getElementById('purchaseModal').classList.remove('active');
            selectedProduct = null;
            
            // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°çŠ¶æ…‹ã‚’ãƒªã‚»ãƒƒãƒˆ
            document.getElementById('purchaseDetails').style.display = 'block';
            document.getElementById('purchaseLoading').style.display = 'none';
            document.getElementById('confirmPurchaseBtn').disabled = false;
            document.getElementById('cancelPurchaseBtn').disabled = false;
        }

        // è³¼å…¥ç¢ºå®š
        async function confirmPurchase() {
            if (!selectedProduct) return;

            // ãƒœã‚¿ãƒ³ã‚’ç„¡åŠ¹åŒ–
            const confirmBtn = document.getElementById('confirmPurchaseBtn');
            const cancelBtn = document.getElementById('cancelPurchaseBtn');
            confirmBtn.disabled = true;
            cancelBtn.disabled = true;
            
            // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¡¨ç¤º
            document.getElementById('purchaseDetails').style.display = 'none';
            document.getElementById('purchaseLoading').style.display = 'block';

            try {
                const result = await callAPI('purchaseWithItem', {
                    uniqueID: currentUser.uniqueID,
                    displayName: currentUser.displayName,
                    productID: selectedProduct.productID
                });

                if (result.success) {
                    alert('è³¼å…¥å®Œäº†ï¼');
                    closePurchaseModal();
                    loadShopData(); // ãƒ‡ãƒ¼ã‚¿å†èª­ã¿è¾¼ã¿
                } else {
                    alert('è³¼å…¥ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + result.message);
                    // ã‚¨ãƒ©ãƒ¼æ™‚ã¯å…ƒã«æˆ»ã™
                    document.getElementById('purchaseDetails').style.display = 'block';
                    document.getElementById('purchaseLoading').style.display = 'none';
                    confirmBtn.disabled = false;
                    cancelBtn.disabled = false;
                }
            } catch (error) {
                alert('é€šä¿¡ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ');
                console.error('Purchase error:', error);
                // ã‚¨ãƒ©ãƒ¼æ™‚ã¯å…ƒã«æˆ»ã™
                document.getElementById('purchaseDetails').style.display = 'block';
                document.getElementById('purchaseLoading').style.display = 'none';
                confirmBtn.disabled = false;
                cancelBtn.disabled = false;
            }
        }

        // æ—¥ä»˜ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ
        function formatDate(timestamp) {
            const date = new Date(timestamp);
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            const hours = String(date.getHours()).padStart(2, '0');
            const minutes = String(date.getMinutes()).padStart(2, '0');
            
            return `${year}/${month}/${day} ${hours}:${minutes}`;
        }

        // APIå‘¼ã³å‡ºã—
        async function callAPI(action, data) {
            const params = new URLSearchParams();
            params.append('action', action);
            
            for (const key in data) {
                params.append(key, data[key]);
            }
            
            const response = await fetch(API_URL + '?' + params.toString(), {
                method: 'POST',
                body: JSON.stringify({
                    action: action,
                    ...data
                })
            });

            if (!response.ok) {
                throw new Error('Network response was not ok');
            }

            return await response.json();
        }
    </script>
</body>
</html>
