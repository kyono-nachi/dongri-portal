<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>DonGri GAME - HIGH & LOW</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=Oswald:wght@400;600;700&family=Anton&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Georgia', serif;
            background: linear-gradient(135deg, #1a0000 0%, #000000 50%, #1a0000 100%);
            color: #fff;
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 10px;
            overflow-x: hidden;
        }

        /* iPhone 19.5:9 æœ€é©åŒ– */
        @media (max-aspect-ratio: 9/19) {
            body {
                padding: 5px;
            }
            .container {
                height: 100vh;
                display: flex;
                flex-direction: column;
                justify-content: center;
            }
            .screen {
                max-height: 100vh;
                overflow-y: auto;
                padding: 15px 15px !important;
            }
        }

        .container {
            max-width: 600px;
            width: 100%;
        }

        .screen {
            display: none;
            background: rgba(0, 0, 0, 0.8);
            border: 3px solid #d4af37;
            border-radius: 20px;
            padding: 20px 15px;
            box-shadow: 0 0 50px rgba(212, 175, 55, 0.3);
            text-align: center;
        }

        .screen.active {
            display: block;
            animation: fadeIn 0.5s;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        h1 {
            font-size: 1.8em;
            color: #d4af37;
            text-shadow: 0 0 20px rgba(212, 175, 55, 0.5);
            margin-bottom: 5px;
            letter-spacing: 3px;
        }

        h2 {
            font-size: 1.1em;
            color: #d4af37;
            margin-bottom: 15px;
        }

        .input-group {
            margin: 20px 0;
        }

        label {
            display: block;
            font-size: 1em;
            margin-bottom: 10px;
            color: #d4af37;
            font-family: 'Bebas Neue', sans-serif;
            letter-spacing: 1px;
        }

        .btn {
            padding: 12px 24px;
            font-size: 0.9em;
            font-weight: bold;
            font-family: 'Oswald', sans-serif;
            background: linear-gradient(135deg, #d4af37 0%, #f4e5b0 50%, #d4af37 100%);
            color: #000;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            margin: 5px;
            transition: all 0.3s;
            text-transform: uppercase;
            letter-spacing: 2px;
            box-shadow: 0 5px 15px rgba(212, 175, 55, 0.4);
        }

        .btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(212, 175, 55, 0.6);
        }

        .btn:active {
            transform: translateY(0);
        }

        .btn-high {
            background: linear-gradient(135deg, #ff0000 0%, #cc0000 100%);
            color: #fff;
        }

        .btn-low {
            background: linear-gradient(135deg, #0066ff 0%, #0044cc 100%);
            color: #fff;
        }

        .btn-high-black {
            background: linear-gradient(135deg, #8b0000 0%, #5a0000 100%);
            color: #fff;
            font-size: 0.75em;
        }

        .btn-high-red {
            background: linear-gradient(135deg, #ff1744 0%, #d01038 100%);
            color: #fff;
            font-size: 0.75em;
        }

        .btn-low-black {
            background: linear-gradient(135deg, #003d7a 0%, #002850 100%);
            color: #fff;
            font-size: 0.75em;
        }

        .btn-low-red {
            background: linear-gradient(135deg, #0080ff 0%, #0066cc 100%);
            color: #fff;
            font-size: 0.75em;
        }

        .btn-small {
            padding: 8px 16px;
            font-size: 0.85em;
        }

        .btn-dng {
            font-family: 'Bebas Neue', sans-serif;
            font-weight: 400;
            letter-spacing: 2px;
            font-size: 1em;
        }

        .card-display {
            margin: 20px 0;
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 20px;
        }

        .card {
            width: 160px;
            height: 224px;
            background: #fff;
            background-image: url('images/card-pattern-1.svg');
            background-size: cover;
            background-position: center;
            border-radius: 15px;
            display: inline-flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            font-size: 4em;
            font-weight: bold;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
            margin: 5px;
            position: relative;
            transition: transform 0.6s;
            transform-style: preserve-3d;
        }

        .card.flipping {
            animation: cardFlip3D 0.6s;
        }

        @keyframes cardFlip3D {
            0% { transform: rotateY(0deg); }
            50% { transform: rotateY(90deg); }
            100% { transform: rotateY(0deg); }
        }

        .card.back {
            background-image: url('images/card-back.svg');
        }

        .card.back .card-suit,
        .card.back #cardNumber,
        .card.back .next-card-number,
        .card.back .next-card-suit {
            visibility: hidden !important;
            opacity: 0 !important;
        }

        .card.red {
            color: #ff0000;
        }

        .card.black {
            color: #000;
        }

        .card-suit, .next-card-suit {
            font-size: 0.5em;
            margin-bottom: 0px;
            margin-top: -5px;
            text-shadow: 
                -2px -2px 0 rgba(255, 255, 255, 0.5),
                2px -2px 0 rgba(255, 255, 255, 0.5),
                -2px 2px 0 rgba(255, 255, 255, 0.5),
                2px 2px 0 rgba(255, 255, 255, 0.5),
                -2px 0 0 rgba(255, 255, 255, 0.5),
                2px 0 0 rgba(255, 255, 255, 0.5),
                0 -2px 0 rgba(255, 255, 255, 0.5),
                0 2px 0 rgba(255, 255, 255, 0.5);
        }

        #cardNumber, .next-card-number {
            text-shadow: 
                -2px -2px 0 rgba(255, 255, 255, 0.5),
                2px -2px 0 rgba(255, 255, 255, 0.5),
                -2px 2px 0 rgba(255, 255, 255, 0.5),
                2px 2px 0 rgba(255, 255, 255, 0.5),
                -2px 0 0 rgba(255, 255, 255, 0.5),
                2px 0 0 rgba(255, 255, 255, 0.5),
                0 -2px 0 rgba(255, 255, 255, 0.5),
                0 2px 0 rgba(255, 255, 255, 0.5);
        }

        .next-card-number {
            font-size: 1em;
        }

        .dng-display {
            font-size: 1.2em;
            margin: 10px 0;
            padding: 10px;
            background: rgba(212, 175, 55, 0.1);
            border: 2px solid #d4af37;
            border-radius: 10px;
        }

        .dng-display .dng-amount {
            color: #ffd700;
            font-weight: bold;
        }

        .multiplier-info {
            font-size: 0.85em;
            margin: 8px 0;
            padding: 6px;
            background: rgba(100, 149, 237, 0.2);
            border: 1px solid #6495ed;
            border-radius: 8px;
            color: #87ceeb;
        }

        .game-controls {
            margin: 15px 0;
        }

        .button-grid-advanced {
            display: grid;
            grid-template-columns: 1fr 1fr;
            grid-template-rows: repeat(4, 1fr) auto;
            gap: 8px;
            max-width: 450px;
            margin: 0 auto;
        }

        .grid-high {
            grid-column: 1;
            grid-row: 1 / 3;
        }

        .grid-low {
            grid-column: 1;
            grid-row: 3 / 5;
        }

        .grid-item {
            grid-column: 2;
        }

        .grid-allin {
            grid-column: 1 / 3;
            grid-row: 5;
        }

        .btn-all-in {
            background: linear-gradient(135deg, #ff6b00 0%, #ff0000 100%);
            color: #fff;
            font-size: 0.95em;
            animation: pulse-glow 2s infinite;
        }

        @keyframes pulse-glow {
            0%, 100% { box-shadow: 0 5px 15px rgba(255, 107, 0, 0.4); }
            50% { box-shadow: 0 5px 30px rgba(255, 107, 0, 0.8); }
        }

        .button-grid-advanced .btn {
            margin: 0;
            width: 100%;
            padding: 9px 8px;
            line-height: 1.1;
            font-size: 0.85em;
        }

        .grid-high,
        .grid-low {
            font-size: 1em;
            padding: 11px 8px;
        }

        .message {
            font-size: 1.1em;
            color: #ffd700;
            margin: 15px 0;
            padding: 12px;
            background: rgba(212, 175, 55, 0.1);
            border-radius: 10px;
            line-height: 1.4;
        }

        .result-win {
            color: #00ff00;
            font-size: 1.3em;
            font-weight: bold;
            animation: pulse 0.5s;
            line-height: 1.3;
        }

        .result-lose {
            color: #ff0000;
            font-size: 1.3em;
            font-weight: bold;
            line-height: 1.3;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }

        .ticket {
            background: linear-gradient(135deg, #2a0000 0%, #000 100%);
            border: 3px solid #d4af37;
            border-radius: 15px;
            padding: 20px;
            margin: 15px 0;
            text-align: left;
        }

        .ticket-header {
            text-align: center;
            border-bottom: 2px solid #d4af37;
            padding-bottom: 12px;
            margin-bottom: 15px;
        }

        .ticket-row {
            display: flex;
            justify-content: space-between;
            margin: 12px 0;
            font-size: 1em;
        }

        .ticket-label {
            color: #d4af37;
        }

        .ticket-value {
            color: #fff;
            font-weight: bold;
        }

        .serial {
            font-family: 'Courier New', monospace;
            font-size: 1.3em;
            letter-spacing: 3px;
            color: #ffd700;
            text-align: center;
            padding: 12px;
            background: rgba(212, 175, 55, 0.1);
            border-radius: 5px;
            margin: 12px 0;
        }

        @media (max-width: 480px) {
            h1 { font-size: 1.6em; }
            h2 { font-size: 1em; }
            .card {
                width: 135px;
                height: 189px;
                font-size: 3.3em;
            }
            .btn {
                padding: 10px 20px;
                font-size: 0.85em;
                margin: 4px;
            }
            .button-grid-advanced .btn {
                padding: 8px 6px;
                font-size: 0.7em;
            }
            .grid-high,
            .grid-low {
                font-size: 0.9em;
                padding: 10px 6px;
            }
            .grid-allin {
                font-size: 0.85em;
                padding: 8px 6px;
            }
            .screen {
                padding: 15px 12px;
            }
            .dng-display {
                font-size: 1.1em;
                padding: 8px;
                margin: 8px 0;
            }
            .message {
                font-size: 0.95em;
                padding: 8px;
            }
            .ticket {
                padding: 15px;
            }
            .button-grid-advanced {
                gap: 6px;
                max-width: 380px;
            }
        }

        /* ãƒ¢ãƒ¼ãƒ€ãƒ«èƒŒæ™¯ */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 2000;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .modal-overlay.active {
            display: flex;
        }

        /* ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ */
        .modal-content {
            background: linear-gradient(135deg, #1a0000 0%, #000000 50%, #1a0000 100%);
            border: 3px solid #d4af37;
            border-radius: 20px;
            padding: 30px 20px;
            max-width: 500px;
            width: 100%;
            max-height: 80vh;
            display: flex;
            flex-direction: column;
            box-shadow: 0 0 50px rgba(212, 175, 55, 0.5);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #d4af37;
            flex-shrink: 0;
        }

        .modal-title {
            font-size: 1.5em;
            color: #d4af37;
            letter-spacing: 2px;
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 2em;
            color: #d4af37;
            cursor: pointer;
            line-height: 1;
            padding: 0;
            width: 30px;
            height: 30px;
        }

        .modal-close:hover {
            color: #ffd700;
        }

        /* ã‚«ãƒ¼ãƒ‰ãƒ‡ã‚¶ã‚¤ãƒ³é¸æŠ */
        .design-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 15px;
            overflow-y: auto;
            overflow-x: hidden;
            padding-right: 5px;
        }

        /* ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ãƒãƒ¼ã®ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚º */
        .design-grid::-webkit-scrollbar {
            width: 8px;
        }

        .design-grid::-webkit-scrollbar-track {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 4px;
        }

        .design-grid::-webkit-scrollbar-thumb {
            background: rgba(212, 175, 55, 0.5);
            border-radius: 4px;
        }

        .design-grid::-webkit-scrollbar-thumb:hover {
            background: rgba(212, 175, 55, 0.8);
        }

        .design-option {
            background: rgba(212, 175, 55, 0.1);
            border: 2px solid #d4af37;
            border-radius: 10px;
            padding: 15px;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .design-option:hover {
            background: rgba(212, 175, 55, 0.2);
            transform: translateY(-3px);
            box-shadow: 0 5px 20px rgba(212, 175, 55, 0.3);
        }

        .design-option.selected {
            background: rgba(212, 175, 55, 0.3);
            border-color: #ffd700;
            box-shadow: 0 0 20px rgba(255, 215, 0, 0.5);
        }

        .design-preview {
            display: flex;
            gap: 8px;
            flex-shrink: 0;
        }

        .design-preview-card {
            width: 50px;
            height: 70px;
            background: #fff;
            border-radius: 6px;
            box-shadow: 0 3px 8px rgba(0, 0, 0, 0.5);
            background-size: cover;
            background-position: center;
        }

        .design-info {
            flex: 1;
        }

        .design-name {
            font-size: 1.1em;
            color: #ffd700;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .design-description {
            font-size: 0.9em;
            color: #aaa;
        }

        @media (max-width: 480px) {
            .dev-menu-icon {
                width: 28px;
                height: 28px;
                font-size: 16px;
                top: 8px;
                right: 8px;
            }
            .modal-content {
                padding: 20px 15px;
            }
        }

        /* ã‚°ãƒ­ãƒ¼ãƒãƒ«ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚° */
        #globalLoading {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            z-index: 99999;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }

        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 4px solid rgba(212, 175, 55, 0.3);
            border-top: 4px solid #d4af37;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .loading-text {
            color: #d4af37;
            font-size: 1.2em;
            margin-top: 20px;
            font-family: 'Bebas Neue', sans-serif;
            letter-spacing: 2px;
        }
    </style>
</head>
<body>
    <!-- ã‚°ãƒ­ãƒ¼ãƒãƒ«ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ -->
    <div id="globalLoading" style="display: none;">
        <div class="loading-spinner"></div>
        <div class="loading-text">èª­ã¿è¾¼ã¿ä¸­...</div>
    </div>

    <!-- ã‚¹ã‚¿ãƒ¼ãƒˆç”»é¢ -->
    <div class="container">
        <div id="startScreen" class="screen active">
            <div style="position: relative;">
                <h1>DonGri GAME</h1>
                <button onclick="clearAllData()" style="position: absolute; top: 0; left: 0; background: rgba(0,0,0,0.05); border: none; font-size: 1.5em; cursor: pointer; color: #666; padding: 5px 10px; border-radius: 5px; line-height: 1; opacity: 0.4;">â‹®</button>
                <button onclick="openHelpModal()" style="position: absolute; top: 0; right: 0; background: rgba(0,0,0,0.05); border: none; font-size: 1.2em; cursor: pointer; color: #888; padding: 5px 10px; border-radius: 5px; line-height: 1; opacity: 0.5;">?</button>
            </div>
            <h2 style="margin-top: 5px; margin-bottom: 20px;">HIGH & LOW</h2>
            <div class="input-group">
                <label style="font-size: 0.9em;">æœ€åˆã«BETã™ã‚‹DNGé¡ã‚’é¸æŠã—ã¦ãã ã•ã„</label>
                <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px; max-width: 350px; margin: 15px auto;">
                    <button class="btn btn-small btn-dng" onclick="selectAmount(10)" style="padding: 16px 10px; line-height: 1.4;"><span style="font-size: 1.5em;">10</span> <span style="font-size: 1.1em;">DNG</span><br><span style="font-size: 0.7em; opacity: 0.75;">(1,500 Y)</span></button>
                    <button class="btn btn-small btn-dng" onclick="selectAmount(20)" style="padding: 16px 10px; line-height: 1.4;"><span style="font-size: 1.5em;">20</span> <span style="font-size: 1.1em;">DNG</span><br><span style="font-size: 0.7em; opacity: 0.75;">(3,000 Y)</span></button>
                    <button class="btn btn-small btn-dng" onclick="selectAmount(50)" style="padding: 16px 10px; line-height: 1.4;"><span style="font-size: 1.5em;">50</span> <span style="font-size: 1.1em;">DNG</span><br><span style="font-size: 0.7em; opacity: 0.75;">(7,500 Y)</span></button>
                    <button class="btn btn-small btn-dng" onclick="selectAmount(100)" style="padding: 16px 10px; line-height: 1.4;"><span style="font-size: 1.5em;">100</span> <span style="font-size: 1.1em;">DNG</span><br><span style="font-size: 0.7em; opacity: 0.75;">(15,000 Y)</span></button>
                    <button class="btn btn-small btn-dng" onclick="selectAmount(500)" style="padding: 16px 10px; line-height: 1.4;"><span style="font-size: 1.5em;">500</span> <span style="font-size: 1.1em;">DNG</span><br><span style="font-size: 0.7em; opacity: 0.75;">(75,000 Y)</span></button>
                    <button class="btn btn-small btn-dng" onclick="selectAmount(1000)" style="padding: 16px 10px; line-height: 1.4;"><span style="font-size: 1.5em;">1000</span> <span style="font-size: 1.1em;">DNG</span><br><span style="font-size: 0.7em; opacity: 0.75;">(150,000 Y)</span></button>
                </div>
            </div>
            <div style="margin-top: 15px; font-size: 0.85em; color: #888;">
                Get Total: <span id="getTotalDNG" style="color: #4CAF50; font-weight: bold;">0</span> DNG
            </div>
            <div style="margin-top: 8px; font-size: 0.85em; color: #888;">
                Loan Total: <span id="totalLoanDNG">0</span> DNG
            </div>
            
            <!-- æ•‘æ¸ˆãƒã‚±ãƒƒãƒˆè¡¨ç¤ºï¼ˆã‚·ãƒ³ãƒ—ãƒ«ç‰ˆï¼‰ -->
            <div style="margin-top: 8px; font-size: 0.85em; color: #888;">
                <span style="cursor: pointer; color: #d4af37;" onclick="openRescueTicketModal()">
                    ğŸ« æ•‘æ¸ˆãƒã‚±ãƒƒãƒˆ: <span id="rescueTicketCount" style="font-weight: bold;">3</span>æš
                </span>
            </div>
            
            <!-- æœ€çµ‚æ¸…ç®—ãƒœã‚¿ãƒ³ -->
            <button class="btn" onclick="finalSettlement()" style="margin-top: 20px; background: linear-gradient(135deg, #b8b8b8 0%, #e8e8e8 50%, #b8b8b8 100%); color: #333; font-size: 1.05em; padding: 15px 30px; box-shadow: 0 5px 20px rgba(158, 158, 158, 0.5);">
                æœ€çµ‚æ¸…ç®—ã—ã¦Bankã«è²¯è”µ
            </button>
            <div style="font-size: 0.8em; color: #4CAF50; margin-top: 8px; text-align: center; font-weight: bold;">
                â€»ã“ã¡ã‚‰ã‚’æŠ¼ã™ã¨å‡¦ç†ãŒå®Œäº†ã—ã¾ã™
            </div>
            
            <!-- ã‚ªãƒ—ã‚·ãƒ§ãƒ³æ©Ÿèƒ½ -->
            <div style="margin-top: 25px; padding-top: 20px; border-top: 1px solid rgba(212, 175, 55, 0.3);">
                <div style="font-size: 0.8em; color: #888; margin-bottom: 12px; letter-spacing: 1px;">OPTIONS</div>
                <button class="btn btn-small" onclick="openDesignUnlockModal()" style="background: rgba(212, 175, 55, 0.05); color: #d4af37; border: 2px solid #d4af37; padding: 10px 20px; box-shadow: none;">
                    ğŸ´ CARD DESIGN
                </button>
                <button class="btn btn-small" onclick="location.href='../shop/'" style="background: rgba(212, 175, 55, 0.05); color: #d4af37; border: 2px solid #d4af37; padding: 10px 20px; box-shadow: none;">
                    ğŸ›’ SHOP
                </button>
                <button class="btn btn-small" onclick="location.href='../'" style="background: rgba(212, 175, 55, 0.05); color: #d4af37; border: 2px solid #d4af37; padding: 10px 20px; box-shadow: none;">
                    ğŸ  PORTAL
                </button>
            </div>
        </div>

        <!-- ã‚²ãƒ¼ãƒ ç”»é¢ -->
        <div id="gameScreen" class="screen">
            <h1>DonGri GAME</h1>
            <h2 style="margin-top: 5px; margin-bottom: 15px;">HIGH & LOW</h2>
            <div class="dng-display">
                <span class="dng-amount" id="currentDNG">0</span> DNG
            </div>

            <div class="multiplier-info" id="multiplierInfo">
                HIGHå€ç‡: <span id="highMultiplier">2.0</span>x | LOWå€ç‡: <span id="lowMultiplier">2.0</span>x
            </div>
            
            <div class="card-display">
                <div id="currentCard" class="card black">
                    <span class="card-suit">â™ </span>
                    <span id="cardNumber">7</span>
                </div>
                <div id="nextCard" class="card back">
                    <span class="next-card-suit">â™ </span>
                    <span class="next-card-number">?</span>
                </div>
            </div>

            <div class="message" id="message">æ¬¡ã®ã‚«ãƒ¼ãƒ‰ã¯ HIGH ã‹ LOW ã‹ï¼Ÿ</div>

            <div class="game-controls">
                <div class="button-grid-advanced">
                    <button class="btn btn-high grid-high" onclick="makeChoice('high')">HIGH <span style="font-size: 0.75em;">(<span id="highBtnMultiplier">2.0</span>x)</span></button>
                    <button class="btn btn-high-black grid-item" onclick="makeChoice('high', 'black')">â™ â™£é»’HIGH <span style="font-size: 0.7em;">(<span id="highBlackMultiplier">4.0</span>x)</span></button>
                    <button class="btn btn-high-red grid-item" onclick="makeChoice('high', 'red')">â™¥â™¦èµ¤HIGH <span style="font-size: 0.7em;">(<span id="highRedMultiplier">4.0</span>x)</span></button>
                    <button class="btn btn-low grid-low" onclick="makeChoice('low')">LOW <span style="font-size: 0.75em;">(<span id="lowBtnMultiplier">2.0</span>x)</span></button>
                    <button class="btn btn-low-black grid-item" onclick="makeChoice('low', 'black')">â™ â™£é»’LOW <span style="font-size: 0.7em;">(<span id="lowBlackMultiplier">4.0</span>x)</span></button>
                    <button class="btn btn-low-red grid-item" onclick="makeChoice('low', 'red')">â™¥â™¦èµ¤LOW <span style="font-size: 0.7em;">(<span id="lowRedMultiplier">4.0</span>x)</span></button>
                    <button class="btn btn-all-in grid-allin" onclick="allIn()" id="allInBtn">ğŸ”¥ ALL IN ğŸ”¥</button>
                </div>
            </div>

            <div style="margin-top: 15px;">
                <button class="btn btn-small" onclick="cashOut()">ã“ã®ã‚²ãƒ¼ãƒ ã‚’æ¸…ç®—ã—ã¦çµ‚äº†</button>
            </div>
        </div>

        <!-- ãƒã‚±ãƒƒãƒˆç”»é¢ -->
        <div id="ticketScreen" class="screen">
            <h1>æ¸…ç®—ãƒã‚±ãƒƒãƒˆ</h1>
            
            <div class="ticket">
                <div class="ticket-header">
                    <h2>DonGri GAME</h2>
                    <p style="font-size: 0.9em;">HIGH & LOW - OFFICIAL TICKET</p>
                </div>

                <div class="serial" id="serialNumber">XXXXXXXX</div>

                <div class="ticket-row">
                    <span class="ticket-label">æœ€çµ‚DNGé¡:</span>
                    <span class="ticket-value" id="finalDNG">0 DNG</span>
                </div>

                <div class="ticket-row">
                    <span class="ticket-label">Loan DNG:</span>
                    <span class="ticket-value" id="ticketLoanDNG">0 DNG</span>
                </div>

                <div class="ticket-row" style="border-top: 1px solid #d4af37; padding-top: 10px; margin-top: 10px;">
                    <span class="ticket-label">æ¸…ç®—å¾ŒLoan DNG:</span>
                    <span class="ticket-value" id="ticketLoanRepayment">0 DNG</span>
                </div>

                <div class="ticket-row">
                    <span class="ticket-label">ä½™å‰°åˆ©ç›Š:</span>
                    <span class="ticket-value" id="ticketSurplusProfit">0 DNG</span>
                </div>

                <div class="ticket-row" id="conversionRow" style="display: none;">
                    <span class="ticket-label">æ›ç®—é¡:</span>
                    <span class="ticket-value" id="ticketConversion">0 Y</span>
                </div>

                <div class="ticket-row">
                    <span class="ticket-label">ãƒ—ãƒ¬ã‚¤æ—¥æ™‚:</span>
                    <span class="ticket-value" id="playDateTime">2024-01-01 12:00:00</span>
                </div>
            </div>

            <!-- æ”¯æ‰•ã„æ¼”å‡º -->
            <div id="paymentSection" style="display: none; margin-top: 20px;">
                <div style="background: rgba(255, 0, 0, 0.1); border: 2px solid #ff0000; border-radius: 15px; padding: 15px;">
                    <div style="display: flex; align-items: center; justify-content: center; gap: 15px; flex-wrap: wrap;">
                        <div style="width: 100px; height: 100px; background: #fff; border-radius: 10px; display: flex; align-items: center; justify-content: center; font-size: 2.5em;">
                            ğŸ’¸
                        </div>
                        <div style="flex: 1; min-width: 180px; text-align: center;">
                            <div style="font-size: 1.2em; color: #ff6666; font-weight: bold; margin-bottom: 8px;">
                                ãŠæ”¯æ‰•ã„ã‚’ãŠé¡˜ã„ã—ã¾ã™
                            </div>
                            <div style="font-size: 1.1em; color: #d4af37;">
                                æ”¯æ‰•é¡: <span id="paymentAmount" style="font-weight: bold;">0 Y</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <button class="btn" id="restartButton" onclick="resetGame()" style="margin-top: 20px;">æ–°ã—ã„ã‚²ãƒ¼ãƒ ã‚’å§‹ã‚ã‚‹</button>
            <button class="btn btn-small" onclick="finalSettlement()" style="margin-top: 10px; background: linear-gradient(135deg, #888 0%, #bbb 100%); color: #fff;">æœ€çµ‚æ¸…ç®—</button>
        </div>

        <!-- æœ€çµ‚æ¸…ç®—ç”»é¢ -->
        <div id="finalSettlementScreen" class="screen">
            <h1>æœ€çµ‚æ¸…ç®—ãƒã‚±ãƒƒãƒˆ</h1>
            
            <div class="ticket">
                <div class="ticket-header">
                    <h2>DonGri GAME</h2>
                    <p style="font-size: 0.9em;">HIGH & LOW - FINAL SETTLEMENT</p>
                </div>

                <div class="serial" id="finalSerial">XXXXXXXX</div>

                <div class="ticket-row">
                    <span class="ticket-label">ç´¯è¨ˆGet Total:</span>
                    <span class="ticket-value" id="finalGetTotal">0 DNG</span>
                </div>

                <div class="ticket-row">
                    <span class="ticket-label">ç´¯è¨ˆLoan Total:</span>
                    <span class="ticket-value" id="finalLoanTotal">0 DNG</span>
                </div>

                <div class="ticket-row" style="border-top: 1px solid #d4af37; padding-top: 10px; margin-top: 10px;">
                    <span class="ticket-label">ç´”ç›Š:</span>
                    <span class="ticket-value" id="finalProfit">0 DNG</span>
                </div>

                <div class="ticket-row">
                    <span class="ticket-label">ã‚²ãƒ¼ãƒ å›æ•°:</span>
                    <span class="ticket-value" id="finalGameCount">0å›</span>
                </div>

                <div class="ticket-row">
                    <span class="ticket-label">æœŸé–“:</span>
                    <span class="ticket-value" id="finalPeriod">2024-01-01 ã€œ 2024-01-01</span>
                </div>
            </div>

            <div class="message" style="font-size: 0.95em;">
                <span style="font-size: 0.9em; color: #d4af37;">æ¸…ç®—ã‚’ç¢ºå®šã™ã‚‹ã¨ã€DonGri Bankã«è‡ªå‹•è²¯è”µã•ã‚Œã¾ã™</span><br>
                <span style="font-size: 0.9em; color: #ff6666;">â€»æ¸…ç®—å¾Œã€å…¨ãƒ‡ãƒ¼ã‚¿ãŒãƒªã‚»ãƒƒãƒˆã•ã‚Œã¾ã™</span>
            </div>

            <button class="btn" onclick="confirmFinalSettlement()">æ¸…ç®—ã‚’ç¢ºå®šã—ã¦ãƒªã‚»ãƒƒãƒˆ</button>
            <button class="btn btn-small" onclick="switchScreen('finalSettlementScreen', 'startScreen')" style="margin-top: 10px;">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
        </div>
    </div>

    <!-- ãƒ‡ã‚¶ã‚¤ãƒ³è§£æ”¾ãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div id="designUnlockModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.85); z-index: 10000; justify-content: center; align-items: center; overflow-y: auto; padding: 20px;">
        <div style="background: linear-gradient(135deg, #1a0000 0%, #000000 50%, #1a0000 100%); border: 3px solid #d4af37; border-radius: 20px; padding: 30px; max-width: 600px; width: 100%; max-height: 90vh; overflow-y: auto; box-shadow: 0 0 50px rgba(212, 175, 55, 0.5); margin: auto; position: relative;">
            <button onclick="closeDesignUnlockModal()" style="position: absolute; top: 15px; right: 15px; background: rgba(0, 0, 0, 0.3); border: none; color: #888; font-size: 1.5em; cursor: pointer; width: 35px; height: 35px; border-radius: 50%; line-height: 1; padding: 0;">Ã—</button>
            
            <h2 style="color: #d4af37; margin-bottom: 10px; text-align: center; font-family: 'Bebas Neue', sans-serif; font-size: 2em;">ğŸ´ ã‚«ãƒ¼ãƒ‰ãƒ‡ã‚¶ã‚¤ãƒ³</h2>
            <div style="text-align: center; font-size: 0.85em; color: #aaa; margin-bottom: 20px;">
                ç¾åœ¨ä½¿ç”¨ä¸­: <span id="currentDesignName" style="color: #4CAF50; font-weight: bold;">åŸºæœ¬ãƒ‡ã‚¶ã‚¤ãƒ³</span>
            </div>
            
            <div id="designGrid" style="max-height: 50vh; overflow-y: auto; padding: 10px;">
                <!-- ãƒ‡ã‚¶ã‚¤ãƒ³ã‚«ãƒ¼ãƒ‰ãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã‚‹ -->
            </div>

            <div style="text-align: center; margin-top: 20px; padding: 12px 15px; background: rgba(212, 175, 55, 0.1); border-radius: 10px; border: 1px solid rgba(212, 175, 55, 0.3);">
                <div style="font-size: 0.95em; color: #d4af37; margin-bottom: 8px;">
                    ğŸ« æ‰€æŒãƒã‚±ãƒƒãƒˆ: <span id="modalTicketCount" style="font-weight: bold; font-size: 1.2em;">0</span>æš
                </div>
                <div style="font-size: 0.8em; color: #888;">
                    â€» ãƒã‚±ãƒƒãƒˆ1æšã§ãƒ‡ã‚¶ã‚¤ãƒ³ã‚’1ã¤è§£æ”¾ã§ãã¾ã™
                </div>
                <div style="font-size: 0.8em; color: #888; margin-top: 3px;">
                    â€» è¿½åŠ ãƒã‚±ãƒƒãƒˆã¯SHOPã§è³¼å…¥ã§ãã¾ã™
                </div>
            </div>
        </div>
    </div>

    <!-- æ•‘æ¸ˆãƒã‚±ãƒƒãƒˆãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div id="rescueTicketModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.85); z-index: 10000; justify-content: center; align-items: center; overflow-y: auto; padding: 20px;">
        <div style="background: linear-gradient(135deg, #1a0000 0%, #000000 50%, #1a0000 100%); border: 3px solid #d4af37; border-radius: 20px; padding: 30px; max-width: 450px; width: 100%; box-shadow: 0 0 50px rgba(212, 175, 55, 0.5); margin: auto;">
            <h2 style="color: #d4af37; margin-bottom: 20px; text-align: center; font-family: 'Bebas Neue', sans-serif; font-size: 2em;">ğŸ« æ•‘æ¸ˆãƒã‚±ãƒƒãƒˆ</h2>
            
            <!-- èª¬æ˜ -->
            <div style="margin-bottom: 25px; padding: 20px; background: rgba(212, 175, 55, 0.1); border-radius: 15px; border: 1px solid rgba(212, 175, 55, 0.3);">
                <div style="font-size: 1em; color: #fff; line-height: 1.8; margin-bottom: 15px;">
                    <strong style="color: #d4af37;">æ•‘æ¸ˆãƒã‚±ãƒƒãƒˆã¨ã¯ï¼Ÿ</strong><br>
                    ç´¯ç©ã—ãŸãƒ­ãƒ¼ãƒ³ã‚’<span style="color: #d4af37; font-weight: bold;">å®Œå…¨ã«ã‚¼ãƒ­</span>ã«ã§ãã‚‹ç‰¹åˆ¥ãªã‚¢ã‚¤ãƒ†ãƒ ã§ã™ã€‚
                </div>
                <div style="font-size: 0.9em; color: #aaa; line-height: 1.6;">
                    ãƒ»ç¾åœ¨ã®ãƒ­ãƒ¼ãƒ³: <span id="modalCurrentLoan" style="color: #f44336; font-weight: bold;">0</span> DNG<br>
                    ãƒ»æ‰€æŒãƒã‚±ãƒƒãƒˆæ•°: <span id="modalTicketCount" style="color: #d4af37; font-weight: bold;">0</span>æš
                </div>
            </div>

            <!-- ãƒœã‚¿ãƒ³ -->
            <button id="useTicketBtn" class="btn" onclick="confirmUseRescueTicket()" style="width: 100%; background: linear-gradient(135deg, #d4af37 0%, #f4e5b0 50%, #d4af37 100%); color: #000; font-size: 1.1em; margin-bottom: 10px;">
                ğŸ« æ•‘æ¸ˆãƒã‚±ãƒƒãƒˆã‚’ä½¿ç”¨ã™ã‚‹
            </button>

            <div style="text-align: center; margin: 15px 0; font-size: 0.9em; color: #888;">
                ã¾ãŸã¯
            </div>

            <button class="btn" onclick="goToShop()" style="width: 100%; background: rgba(212, 175, 55, 0.1); color: #d4af37; border: 2px solid #d4af37; font-size: 1em; margin-bottom: 15px; box-shadow: none;">
                ğŸ›’ SHOPã§è¿½åŠ è³¼å…¥ (100 DNG)
            </button>

            <button class="btn btn-secondary" onclick="closeRescueTicketModal()" style="width: 100%; background: rgba(100, 100, 100, 0.3); color: #aaa;">
                é–‰ã˜ã‚‹
            </button>
        </div>
    </div>

    <!-- ãƒãƒ¥ãƒ¼ãƒˆãƒªã‚¢ãƒ«/ãƒ˜ãƒ«ãƒ—ãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div id="helpModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.9); z-index: 10000; justify-content: center; align-items: center; overflow-y: auto; padding: 20px;">
        <div style="background: linear-gradient(135deg, #1a0000 0%, #000000 50%, #1a0000 100%); border: 3px solid #d4af37; border-radius: 20px; padding: 30px 20px; max-width: 500px; width: 100%; box-shadow: 0 0 50px rgba(212, 175, 55, 0.5); margin: auto;">
            
            <!-- ã‚¹ãƒ©ã‚¤ãƒ‰1: ã‚ˆã†ã“ã -->
            <div id="tutorialSlide1" class="tutorial-slide">
                <div style="position: relative;">
                    <h2 style="color: #d4af37; margin-bottom: 20px; text-align: center; font-family: 'Bebas Neue', sans-serif; font-size: 2em;">ğŸ´ ã‚ˆã†ã“ãï¼</h2>
                    <button onclick="skipTutorial()" style="position: absolute; top: 0; right: 0; background: none; border: none; color: #888; font-size: 0.9em; cursor: pointer; text-decoration: underline; padding: 0;">Skip</button>
                </div>
                <div style="text-align: center; margin-bottom: 25px;">
                    <div style="font-size: 1.5em; color: #d4af37; font-family: 'Bebas Neue', sans-serif; margin-bottom: 10px;">DonGri HIGH & LOW</div>
                </div>
                <div style="font-size: 1em; color: #fff; line-height: 1.8; margin-bottom: 20px;">
                    ã‚«ãƒ¼ãƒ‰ã®æ•°å­—ã‚’äºˆæƒ³ã—ã¦<br>
                    DNGã‚’ç¨¼ããƒã‚¤ãƒ­ãƒ¼ã‚²ãƒ¼ãƒ ã§ã™<br><br>
                    æ¬¡ã®ã‚«ãƒ¼ãƒ‰ãŒç¾åœ¨ã®ã‚«ãƒ¼ãƒ‰ã‚ˆã‚Š<br>
                    <strong style="color: #4CAF50;">HIGHï¼ˆå¤§ãã„ï¼‰</strong>ã‹<strong style="color: #f44336;">LOWï¼ˆå°ã•ã„ï¼‰</strong>ã‹ã‚’<br>
                    äºˆæ¸¬ã—ã¦ãã ã•ã„ï¼
                </div>
                <div style="text-align: center; margin-bottom: 20px;">
                    <div style="display: inline-flex; gap: 8px; align-items: center;">
                        <span style="width: 30px; height: 6px; background: #d4af37; border-radius: 3px;"></span>
                        <span style="width: 30px; height: 6px; background: rgba(212, 175, 55, 0.3); border-radius: 3px;"></span>
                        <span style="width: 30px; height: 6px; background: rgba(212, 175, 55, 0.3); border-radius: 3px;"></span>
                        <span style="width: 30px; height: 6px; background: rgba(212, 175, 55, 0.3); border-radius: 3px;"></span>
                        <span style="width: 30px; height: 6px; background: rgba(212, 175, 55, 0.3); border-radius: 3px;"></span>
                    </div>
                </div>
                <div style="display: flex; gap: 10px; justify-content: flex-end;">
                    <button class="btn" onclick="nextTutorialSlide()" style="flex: 0 0 auto; min-width: 120px; background: linear-gradient(135deg, #d4af37 0%, #f4e5b0 50%, #d4af37 100%); color: #000;">Next</button>
                </div>
            </div>

            <!-- ã‚¹ãƒ©ã‚¤ãƒ‰2: ãŠé‡‘ã®ä»•çµ„ã¿ -->
            <div id="tutorialSlide2" class="tutorial-slide" style="display: none;">
                <div style="position: relative;">
                    <h2 style="color: #d4af37; margin-bottom: 20px; text-align: center; font-family: 'Bebas Neue', sans-serif; font-size: 2em;">ğŸ’° ãŠé‡‘ã®ä»•çµ„ã¿</h2>
                    <button onclick="skipTutorial()" style="position: absolute; top: 0; right: 0; background: none; border: none; color: #888; font-size: 0.9em; cursor: pointer; text-decoration: underline; padding: 0;">Skip</button>
                </div>
                <div style="font-size: 0.95em; color: #fff; line-height: 1.8; margin-bottom: 20px;">
                    <div style="margin-bottom: 15px; padding: 12px; background: rgba(244, 67, 54, 0.1); border-left: 4px solid #f44336; border-radius: 5px;">
                        <strong style="color: #f44336;">ã€Loanï¼ˆãƒ­ãƒ¼ãƒ³ï¼‰ã€‘</strong><br>
                        ã‚²ãƒ¼ãƒ é–‹å§‹æ™‚ã«å€Ÿã‚Šã‚‹ãŠé‡‘<br>
                        è² ã‘ã‚‹ã¨å¢—ãˆã¦ã„ãã¾ã™
                    </div>
                    <div style="margin-bottom: 15px; padding: 12px; background: rgba(76, 175, 80, 0.1); border-left: 4px solid #4CAF50; border-radius: 5px;">
                        <strong style="color: #4CAF50;">ã€Get Totalã€‘</strong><br>
                        å‹ã£ã¦ç²å¾—ã—ãŸãŠé‡‘ã®åˆè¨ˆ
                    </div>
                    <div style="padding: 12px; background: rgba(212, 175, 55, 0.1); border-left: 4px solid #d4af37; border-radius: 5px;">
                        <strong style="color: #d4af37;">ã€ç´”ç›Š = Get Total - Loanã€‘</strong><br>
                        ã“ã‚ŒãŒãƒ—ãƒ©ã‚¹ãªã‚‰åˆ©ç›ŠãŒå‡ºã¦ã„ã¾ã™ï¼
                    </div>
                </div>
                <div style="text-align: center; margin-bottom: 20px;">
                    <div style="display: inline-flex; gap: 8px; align-items: center;">
                        <span style="width: 30px; height: 6px; background: rgba(212, 175, 55, 0.3); border-radius: 3px;"></span>
                        <span style="width: 30px; height: 6px; background: #d4af37; border-radius: 3px;"></span>
                        <span style="width: 30px; height: 6px; background: rgba(212, 175, 55, 0.3); border-radius: 3px;"></span>
                        <span style="width: 30px; height: 6px; background: rgba(212, 175, 55, 0.3); border-radius: 3px;"></span>
                        <span style="width: 30px; height: 6px; background: rgba(212, 175, 55, 0.3); border-radius: 3px;"></span>
                    </div>
                </div>
                <div style="display: flex; gap: 10px; justify-content: space-between;">
                    <button class="btn btn-secondary" onclick="prevTutorialSlide()" style="flex: 0 0 auto; min-width: 100px; background: rgba(212, 175, 55, 0.05); color: #d4af37; border: 2px solid #d4af37; box-shadow: none;">Back</button>
                    <button class="btn" onclick="nextTutorialSlide()" style="flex: 0 0 auto; min-width: 120px; background: linear-gradient(135deg, #d4af37 0%, #f4e5b0 50%, #d4af37 100%); color: #000;">Next</button>
                </div>
            </div>

            <!-- ã‚¹ãƒ©ã‚¤ãƒ‰3: æ¸…ç®—ã¨Bank -->
            <div id="tutorialSlide3" class="tutorial-slide" style="display: none;">
                <div style="position: relative;">
                    <h2 style="color: #d4af37; margin-bottom: 20px; text-align: center; font-family: 'Bebas Neue', sans-serif; font-size: 2em;">ğŸ¦ æ¸…ç®—ã¨ Bank</h2>
                    <button onclick="skipTutorial()" style="position: absolute; top: 0; right: 0; background: none; border: none; color: #888; font-size: 0.9em; cursor: pointer; text-decoration: underline; padding: 0;">Skip</button>
                </div>
                <div style="font-size: 0.95em; color: #fff; line-height: 1.8; margin-bottom: 20px;">
                    ã‚²ãƒ¼ãƒ ã‚’çµ‚äº†ã™ã‚‹æ™‚ã¯<strong style="color: #d4af37;">ã€Œæ¸…ç®—ã€</strong>ã—ã¾ã™<br><br>
                    <div style="margin-bottom: 10px; padding: 12px; background: rgba(76, 175, 80, 0.1); border-left: 4px solid #4CAF50; border-radius: 5px;">
                        ç´”ç›ŠãŒãƒ—ãƒ©ã‚¹ â†’ <strong style="color: #4CAF50;">DonGri Bankã«è²¯è”µâœ¨</strong>
                    </div>
                    <div style="margin-bottom: 15px; padding: 12px; background: rgba(244, 67, 54, 0.1); border-left: 4px solid #f44336; border-radius: 5px;">
                        ç´”ç›ŠãŒãƒã‚¤ãƒŠã‚¹ â†’ <strong style="color: #f44336;">ãƒ­ãƒ¼ãƒ³ãŒæ®‹ã‚Šã¾ã™ğŸ˜°</strong>
                    </div>
                    Bankã«è²¯ã‚ãŸDNGã¯<br>
                    <strong style="color: #d4af37;">SHOPã§ã‚¢ã‚¤ãƒ†ãƒ ã‚’è²·ãˆã¾ã™ï¼</strong>
                </div>
                <div style="text-align: center; margin-bottom: 20px;">
                    <div style="display: inline-flex; gap: 8px; align-items: center;">
                        <span style="width: 30px; height: 6px; background: rgba(212, 175, 55, 0.3); border-radius: 3px;"></span>
                        <span style="width: 30px; height: 6px; background: rgba(212, 175, 55, 0.3); border-radius: 3px;"></span>
                        <span style="width: 30px; height: 6px; background: #d4af37; border-radius: 3px;"></span>
                        <span style="width: 30px; height: 6px; background: rgba(212, 175, 55, 0.3); border-radius: 3px;"></span>
                        <span style="width: 30px; height: 6px; background: rgba(212, 175, 55, 0.3); border-radius: 3px;"></span>
                    </div>
                </div>
                <div style="display: flex; gap: 10px; justify-content: space-between;">
                    <button class="btn btn-secondary" onclick="prevTutorialSlide()" style="flex: 0 0 auto; min-width: 100px; background: rgba(212, 175, 55, 0.05); color: #d4af37; border: 2px solid #d4af37; box-shadow: none;">Back</button>
                    <button class="btn" onclick="nextTutorialSlide()" style="flex: 0 0 auto; min-width: 120px; background: linear-gradient(135deg, #d4af37 0%, #f4e5b0 50%, #d4af37 100%); color: #000;">Next</button>
                </div>
            </div>

            <!-- ã‚¹ãƒ©ã‚¤ãƒ‰4: æ•‘æ¸ˆãƒã‚±ãƒƒãƒˆ -->
            <div id="tutorialSlide4" class="tutorial-slide" style="display: none;">
                <div style="position: relative;">
                    <h2 style="color: #d4af37; margin-bottom: 20px; text-align: center; font-family: 'Bebas Neue', sans-serif; font-size: 2em;">ğŸ« æ•‘æ¸ˆãƒã‚±ãƒƒãƒˆ</h2>
                    <button onclick="skipTutorial()" style="position: absolute; top: 0; right: 0; background: none; border: none; color: #888; font-size: 0.9em; cursor: pointer; text-decoration: underline; padding: 0;">Skip</button>
                </div>
                <div style="font-size: 0.95em; color: #fff; line-height: 1.8; margin-bottom: 20px;">
                    ãƒ­ãƒ¼ãƒ³ãŒè†¨ã‚‰ã‚“ã æ™‚ã®<br>
                    <strong style="color: #d4af37;">æ•‘æ¸ˆã‚¢ã‚¤ãƒ†ãƒ </strong><br><br>
                    ä½¿ã†ã¨ãƒ­ãƒ¼ãƒ³ãŒ<br>
                    <strong style="color: #4CAF50; font-size: 1.2em;">å®Œå…¨ã«ã‚¼ãƒ­</strong>ã«ãªã‚Šã¾ã™<br><br>
                    <div style="padding: 15px; background: rgba(212, 175, 55, 0.15); border: 2px solid #d4af37; border-radius: 10px; text-align: center; margin: 15px 0;">
                        <div style="font-size: 1.2em; color: #d4af37; margin-bottom: 8px;">ã€åˆå›ç‰¹å…¸ã€‘</div>
                        <div style="font-size: 1.5em; color: #d4af37;">ğŸ« 3æšãƒ—ãƒ¬ã‚¼ãƒ³ãƒˆä¸­ï¼</div>
                    </div>
                    è¿½åŠ è³¼å…¥ã¯SHOPã§å¯èƒ½ã§ã™<br>
                    <span style="color: #888; font-size: 0.9em;">(100 DNG / æš)</span>
                </div>
                <div style="text-align: center; margin-bottom: 20px;">
                    <div style="display: inline-flex; gap: 8px; align-items: center;">
                        <span style="width: 30px; height: 6px; background: rgba(212, 175, 55, 0.3); border-radius: 3px;"></span>
                        <span style="width: 30px; height: 6px; background: rgba(212, 175, 55, 0.3); border-radius: 3px;"></span>
                        <span style="width: 30px; height: 6px; background: rgba(212, 175, 55, 0.3); border-radius: 3px;"></span>
                        <span style="width: 30px; height: 6px; background: #d4af37; border-radius: 3px;"></span>
                        <span style="width: 30px; height: 6px; background: rgba(212, 175, 55, 0.3); border-radius: 3px;"></span>
                    </div>
                </div>
                <div style="display: flex; gap: 10px; justify-content: space-between;">
                    <button class="btn btn-secondary" onclick="prevTutorialSlide()" style="flex: 0 0 auto; min-width: 100px; background: rgba(212, 175, 55, 0.05); color: #d4af37; border: 2px solid #d4af37; box-shadow: none;">Back</button>
                    <button class="btn" onclick="nextTutorialSlide()" style="flex: 0 0 auto; min-width: 120px; background: linear-gradient(135deg, #d4af37 0%, #f4e5b0 50%, #d4af37 100%); color: #000;">Next</button>
                </div>
            </div>

            <!-- ã‚¹ãƒ©ã‚¤ãƒ‰5: ã‚«ãƒ¼ãƒ‰ãƒ‡ã‚¶ã‚¤ãƒ³ -->
            <div id="tutorialSlide5" class="tutorial-slide" style="display: none;">
                <div style="position: relative;">
                    <h2 style="color: #d4af37; margin-bottom: 20px; text-align: center; font-family: 'Bebas Neue', sans-serif; font-size: 2em;">ğŸ´ ã‚«ãƒ¼ãƒ‰ãƒ‡ã‚¶ã‚¤ãƒ³</h2>
                    <button onclick="skipTutorial()" style="position: absolute; top: 0; right: 0; background: none; border: none; color: #888; font-size: 0.9em; cursor: pointer; text-decoration: underline; padding: 0;">Skip</button>
                </div>
                <div style="font-size: 0.95em; color: #fff; line-height: 1.8; margin-bottom: 20px;">
                    ã“ã®ã‚²ãƒ¼ãƒ ã®<strong style="color: #d4af37; font-size: 1.1em;">ç›®ç‰æ©Ÿèƒ½</strong>ã§ã™ï¼<br><br>
                    <div style="padding: 15px; background: rgba(212, 175, 55, 0.15); border: 2px solid #d4af37; border-radius: 10px; margin: 15px 0;">
                        <strong style="color: #d4af37;">é…ä¿¡è€…ãŒä½œã£ãŸç‰¹åˆ¥ãªã‚«ãƒ¼ãƒ‰ãƒ‡ã‚¶ã‚¤ãƒ³</strong>ã‚’<br>
                        <strong style="color: #4CAF50;">ãƒã‚±ãƒƒãƒˆã§è§£æ”¾</strong>ã§ãã¾ã™ï¼
                    </div>
                    <div style="font-size: 0.9em; color: #aaa; line-height: 1.6; margin-top: 15px;">
                        ğŸ’¡ éŠã³æ–¹<br>
                        â‘  ã‚²ãƒ¼ãƒ ã‚’ãƒ—ãƒ¬ã‚¤ã—ã¦DNGã‚’è²¯ã‚ã‚‹<br>
                        â‘¡ SHOPã§ãƒ‡ã‚¶ã‚¤ãƒ³ãƒã‚±ãƒƒãƒˆã‚’è³¼å…¥<br>
                        â‘¢ OPTIONSã‹ã‚‰å¥½ããªãƒ‡ã‚¶ã‚¤ãƒ³ã‚’è§£æ”¾<br>
                        â‘£ æ¨ã—ã®ãƒ‡ã‚¶ã‚¤ãƒ³ã§ãƒ—ãƒ¬ã‚¤ï¼
                    </div>
                </div>
                <div style="text-align: center; margin-bottom: 20px;">
                    <div style="display: inline-flex; gap: 8px; align-items: center;">
                        <span style="width: 30px; height: 6px; background: rgba(212, 175, 55, 0.3); border-radius: 3px;"></span>
                        <span style="width: 30px; height: 6px; background: rgba(212, 175, 55, 0.3); border-radius: 3px;"></span>
                        <span style="width: 30px; height: 6px; background: rgba(212, 175, 55, 0.3); border-radius: 3px;"></span>
                        <span style="width: 30px; height: 6px; background: rgba(212, 175, 55, 0.3); border-radius: 3px;"></span>
                        <span style="width: 30px; height: 6px; background: #d4af37; border-radius: 3px;"></span>
                    </div>
                </div>
                <div style="display: flex; gap: 10px; justify-content: space-between;">
                    <button class="btn btn-secondary" onclick="prevTutorialSlide()" style="flex: 0 0 auto; min-width: 100px; background: rgba(212, 175, 55, 0.05); color: #d4af37; border: 2px solid #d4af37; box-shadow: none;">Back</button>
                    <button class="btn" onclick="closeHelpModal()" style="flex: 0 0 auto; min-width: 140px; background: linear-gradient(135deg, #d4af37 0%, #f4e5b0 50%, #d4af37 100%); color: #000; font-size: 1em;">ã‚²ãƒ¼ãƒ ã‚’å§‹ã‚ã¾ã—ã‚‡ã†ï¼</button>
                </div>
            </div>

        </div>
    </div>

    <script>
        // ã‚°ãƒ­ãƒ¼ãƒãƒ«ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¡¨ç¤º
        function showGlobalLoading(message = 'èª­ã¿è¾¼ã¿ä¸­...') {
            const loadingEl = document.getElementById('globalLoading');
            const textEl = loadingEl.querySelector('.loading-text');
            textEl.textContent = message;
            loadingEl.style.display = 'flex';
        }

        // ã‚°ãƒ­ãƒ¼ãƒãƒ«ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°éè¡¨ç¤º
        function hideGlobalLoading() {
            const loadingEl = document.getElementById('globalLoading');
            loadingEl.style.display = 'none';
        }

        // API URL
        const API_URL = 'https://script.google.com/macros/s/AKfycbyFxDv-KWnawfsrC2Kl82Gavo_s0ZGqEA4zrPPc3LVY9S3FuL_dC7QgkYv5hMeeiQo8/exec';
        
        let currentDNG = 0;
        let currentCardValue = 0;
        let currentCardSuit = '';
        let totalLoanDNG = 0;
        let freeDNG = 0;
        let gameStartLoanDNG = 0;
        let gameLoanDNG = 0;
        let gameCount = 0;
        let firstPlayDate = '';
        let isAllInMode = false; // ã‚ªãƒ¼ãƒ«ã‚¤ãƒ³ãƒ¢ãƒ¼ãƒ‰ã‹ã©ã†ã‹
        let sessionID = ''; // ã‚»ãƒƒã‚·ãƒ§ãƒ³ID
        let sessionStartTime = 0; // ã‚»ãƒƒã‚·ãƒ§ãƒ³é–‹å§‹æ™‚åˆ»
        let rescueTickets = 3; // æ•‘æ¸ˆãƒã‚±ãƒƒãƒˆï¼ˆåˆæœŸå€¤3æšï¼‰

        const suits = ['â™ ', 'â™¥', 'â™¦', 'â™£'];
        const redSuits = ['â™¥', 'â™¦'];
        const Y_RATE = 150;

        // ã‚«ãƒ¼ãƒ‰ãƒ‡ã‚¶ã‚¤ãƒ³ãƒ‡ãƒ¼ã‚¿
        // ã‚«ãƒ¼ãƒ‰ãƒ‡ã‚¶ã‚¤ãƒ³ã®èª­ã¿è¾¼ã¿
        // ã‚«ãƒ¼ãƒ‰ãƒ‡ã‚¶ã‚¤ãƒ³ã®èª­ã¿è¾¼ã¿
        function loadCardDesign() {
            const saved = localStorage.getItem('cardDesign') || 'default';
            const design = availableDesigns.find(d => d.id === saved);
            if (design) {
                applyCardDesignFromAvailable(design);
            }
        }

        // ã‚«ãƒ¼ãƒ‰å€¤ã«ã‚ˆã‚‹æœ‰åˆ©ä¸åˆ©ã«å¿œã˜ãŸå€ç‡è¨ˆç®—
        function calculateMultipliers(cardValue) {
            // HIGHå´ã®å‹ã¡ç¢ºç‡ã‚’è¨ˆç®— (1-13ã®ã‚«ãƒ¼ãƒ‰)
            const higherCards = 13 - cardValue; // ã“ã®ã‚«ãƒ¼ãƒ‰ã‚ˆã‚Šå¤§ãã„ã‚«ãƒ¼ãƒ‰ã®æšæ•°
            const lowerCards = cardValue - 1;   // ã“ã®ã‚«ãƒ¼ãƒ‰ã‚ˆã‚Šå°ã•ã„ã‚«ãƒ¼ãƒ‰ã®æšæ•°
            const totalCards = higherCards + lowerCards; // åŒã˜æ•°å­—ã¯é™¤å¤–æ¸ˆã¿
            
            const highWinRate = higherCards / totalCards;
            const lowWinRate = lowerCards / totalCards;
            
            // åŸºæœ¬å€ç‡ã¯2å€å›ºå®š
            const baseMultiplier = 2;
            
            // å‹ç‡ãŒé«˜ã„ã»ã©å€ç‡ã‚’ä¸‹ã’ã‚‹ï¼ˆ1.2å€ï¼‰
            // å‹ç‡ãŒä½ã„ã»ã©å€ç‡ã‚’ä¸Šã’ã‚‹ï¼ˆ5å€ã¾ã§ï¼‰
            let highMultiplier, lowMultiplier;
            
            if (highWinRate > 0.7) {
                // HIGHå´ãŒæœ‰åˆ©ã™ãã‚‹ï¼ˆã‚«ãƒ¼ãƒ‰å€¤ãŒå°ã•ã„ï¼‰
                highMultiplier = 1.2;
                lowMultiplier = 5;
            } else if (highWinRate < 0.3) {
                // LOWå´ãŒæœ‰åˆ©ã™ãã‚‹ï¼ˆã‚«ãƒ¼ãƒ‰å€¤ãŒå¤§ãã„ï¼‰
                highMultiplier = 5;
                lowMultiplier = 1.2;
            } else {
                // æ¯”è¼ƒçš„ãƒãƒ©ãƒ³ã‚¹ãŒè‰¯ã„
                highMultiplier = baseMultiplier;
                lowMultiplier = baseMultiplier;
            }
            
            return { highMultiplier, lowMultiplier };
        }

        // å€ç‡è¡¨ç¤ºã‚’æ›´æ–°
        function updateMultiplierDisplay() {
            const multipliers = calculateMultipliers(currentCardValue);
            
            document.getElementById('highMultiplier').textContent = multipliers.highMultiplier.toFixed(1);
            document.getElementById('lowMultiplier').textContent = multipliers.lowMultiplier.toFixed(1);
            document.getElementById('highBtnMultiplier').textContent = multipliers.highMultiplier.toFixed(1);
            document.getElementById('lowBtnMultiplier').textContent = multipliers.lowMultiplier.toFixed(1);
            
            // è‰²æŒ‡å®šãƒœã‚¿ãƒ³ã®å€ç‡ï¼ˆé€šå¸¸ã®2å€ï¼‰
            document.getElementById('highBlackMultiplier').textContent = (multipliers.highMultiplier * 2).toFixed(1);
            document.getElementById('highRedMultiplier').textContent = (multipliers.highMultiplier * 2).toFixed(1);
            document.getElementById('lowBlackMultiplier').textContent = (multipliers.lowMultiplier * 2).toFixed(1);
            document.getElementById('lowRedMultiplier').textContent = (multipliers.lowMultiplier * 2).toFixed(1);
        }

        function loadLoanDNG() {
            const saved = localStorage.getItem('totalLoanDNG');
            if (saved) {
                totalLoanDNG = parseInt(saved);
                document.getElementById('totalLoanDNG').textContent = totalLoanDNG;
            }
            const savedFreeDNG = localStorage.getItem('freeDNG');
            if (savedFreeDNG) {
                freeDNG = parseInt(savedFreeDNG);
                document.getElementById('getTotalDNG').textContent = freeDNG;
            }
            const savedGameCount = localStorage.getItem('gameCount');
            if (savedGameCount) {
                gameCount = parseInt(savedGameCount);
            }
            const savedFirstPlayDate = localStorage.getItem('firstPlayDate');
            if (savedFirstPlayDate) {
                firstPlayDate = savedFirstPlayDate;
            }
            const savedRescueTickets = localStorage.getItem('rescueTickets');
            if (savedRescueTickets) {
                rescueTickets = parseInt(savedRescueTickets);
            }
            updateRescueTicketDisplay();
        }

        function saveLoanDNG() {
            localStorage.setItem('totalLoanDNG', totalLoanDNG);
            localStorage.setItem('freeDNG', freeDNG);
            localStorage.setItem('gameCount', gameCount);
            localStorage.setItem('firstPlayDate', firstPlayDate);
            localStorage.setItem('rescueTickets', rescueTickets);
        }

        // æ•‘æ¸ˆãƒã‚±ãƒƒãƒˆè¡¨ç¤ºã‚’æ›´æ–°
        function updateRescueTicketDisplay() {
            const totalTickets = window.totalRescueTickets || rescueTickets;
            const ticketCountEl = document.getElementById('rescueTicketCount');
            
            if (ticketCountEl) {
                ticketCountEl.textContent = totalTickets;
            }
        }

        // æ•‘æ¸ˆãƒã‚±ãƒƒãƒˆãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‹ã
        function openRescueTicketModal() {
            const totalTickets = window.totalRescueTickets || rescueTickets;
            
            // ãƒ¢ãƒ¼ãƒ€ãƒ«å†…ã®æƒ…å ±ã‚’æ›´æ–°
            document.getElementById('modalCurrentLoan').textContent = totalLoanDNG.toLocaleString();
            document.getElementById('modalTicketCount').textContent = totalTickets;
            
            // ä½¿ç”¨ãƒœã‚¿ãƒ³ã®æœ‰åŠ¹/ç„¡åŠ¹
            const useBtn = document.getElementById('useTicketBtn');
            if (totalTickets > 0 && totalLoanDNG > 0) {
                useBtn.disabled = false;
                useBtn.style.opacity = '1';
            } else {
                useBtn.disabled = true;
                useBtn.style.opacity = '0.5';
            }
            
            document.getElementById('rescueTicketModal').style.display = 'flex';
        }

        // æ•‘æ¸ˆãƒã‚±ãƒƒãƒˆãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
        function closeRescueTicketModal() {
            document.getElementById('rescueTicketModal').style.display = 'none';
        }

        // SHOPãƒšãƒ¼ã‚¸ã«ç§»å‹•
        function goToShop() {
            window.location.href = '../shop/';
        }

        // æ•‘æ¸ˆãƒã‚±ãƒƒãƒˆä½¿ç”¨ç¢ºèª
        async function confirmUseRescueTicket() {
            const totalTickets = window.totalRescueTickets || rescueTickets;
            
            if (totalTickets <= 0) {
                alert('æ•‘æ¸ˆãƒã‚±ãƒƒãƒˆãŒã‚ã‚Šã¾ã›ã‚“ã€‚');
                return;
            }
            
            if (totalLoanDNG <= 0) {
                alert('ãƒ­ãƒ¼ãƒ³ãŒã‚ã‚Šã¾ã›ã‚“ã€‚');
                return;
            }
            
            const confirmMessage = `æ•‘æ¸ˆãƒã‚±ãƒƒãƒˆã‚’ä½¿ç”¨ã—ã¦ã€ãƒ­ãƒ¼ãƒ³ ${totalLoanDNG.toLocaleString()} DNG ã‚’ã‚¼ãƒ­ã«ã—ã¾ã™ã‹ï¼Ÿ\n\nâ€»æ•‘æ¸ˆãƒã‚±ãƒƒãƒˆãŒ1æšæ¶ˆè²»ã•ã‚Œã¾ã™`;
            
            if (confirm(confirmMessage)) {
                // localStorageåˆ†ã‹ã‚‰å„ªå…ˆçš„ã«æ¶ˆè²»
                if (rescueTickets > 0) {
                    rescueTickets--;
                    saveLoanDNG();
                } else {
                    // localStorageåˆ†ãŒãªã„å ´åˆã¯APIåˆ†ã‹ã‚‰æ¶ˆè²»
                    alert('â€»ã“ã®æ©Ÿèƒ½ã¯ç¾åœ¨ã€åˆå›ä»˜ä¸åˆ†ã®ã¿å¯¾å¿œã—ã¦ã„ã¾ã™ã€‚\nSHOPè³¼å…¥åˆ†ã®æ¶ˆè²»æ©Ÿèƒ½ã¯ä»Šå¾Œå®Ÿè£…äºˆå®šã§ã™ã€‚');
                    return;
                }
                
                totalLoanDNG = 0;
                gameLoanDNG = 0;
                saveLoanDNG();
                
                document.getElementById('totalLoanDNG').textContent = totalLoanDNG;
                
                // ãƒã‚±ãƒƒãƒˆæ•°ã‚’å†åŒæœŸ
                await syncRescueTickets();
                
                // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
                closeRescueTicketModal();
                
                alert('ğŸ’Š æ•‘æ¸ˆãƒã‚±ãƒƒãƒˆã‚’ä½¿ç”¨ã—ã¾ã—ãŸï¼\nãƒ­ãƒ¼ãƒ³ãŒã‚¼ãƒ­ã«ãªã‚Šã¾ã—ãŸï¼');
            }
        }

        // APIè³¼å…¥åˆ†ã®æ•‘æ¸ˆãƒã‚±ãƒƒãƒˆæ•°ã‚’å–å¾—
        async function loadRescueTicketsFromAPI() {
            const uniqueID = localStorage.getItem('playerUniqueID');
            if (!uniqueID) return 0;
            
            try {
                const result = await callAPI('getUserItems', { uniqueID: uniqueID });
                if (result.success && result.data.items) {
                    const rescueItem = result.data.items.find(item => 
                        item.itemType === 'ticket' && item.itemID === 'rescue'
                    );
                    return rescueItem ? rescueItem.quantity : 0;
                }
            } catch (error) {
                console.error('Error loading rescue tickets from API:', error);
            }
            return 0;
        }

        // æ•‘æ¸ˆãƒã‚±ãƒƒãƒˆæ•°ã‚’æ›´æ–°ï¼ˆlocalStorageåˆ† + APIè³¼å…¥åˆ†ï¼‰
        async function syncRescueTickets() {
            const apiTickets = await loadRescueTicketsFromAPI();
            const localTickets = rescueTickets; // localStorageã‹ã‚‰èª­ã¿è¾¼ã‚“ã åˆ†ï¼ˆåˆå›3æšï¼‰
            
            // è¡¨ç¤ºç”¨ã¯åˆç®—
            const totalTickets = localTickets + apiTickets;
            
            // è¡¨ç¤ºã‚’æ›´æ–°
            const ticketCountEl = document.getElementById('rescueTicketCount');
            if (ticketCountEl) {
                ticketCountEl.textContent = totalTickets;
            }
            
            // å®Ÿéš›ã®æ‰€æŒæ•°ã‚’ä¿å­˜ï¼ˆå†…éƒ¨çš„ã«ã¯åˆ†ã‘ã¦ç®¡ç†ï¼‰
            window.apiRescueTickets = apiTickets;
            window.totalRescueTickets = totalTickets;
            
            updateRescueTicketDisplay();
        }

        // APIå‘¼ã³å‡ºã—ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•°
        async function callAPI(action, data, showLoading = true) {
            if (showLoading) {
                showGlobalLoading();
            }
            
            try {
                const response = await fetch(API_URL, {
                    method: 'POST',
                    body: JSON.stringify({
                        action: action,
                        ...data
                    })
                });

                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }

                return await response.json();
            } finally {
                if (showLoading) {
                    hideGlobalLoading();
                }
            }
        }

        // ãƒãƒ¥ãƒ¼ãƒˆãƒªã‚¢ãƒ«é–¢é€£ã®å¤‰æ•°
        let currentTutorialSlide = 1;

        // ãƒ˜ãƒ«ãƒ—ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‹ã
        function openHelpModal() {
            currentTutorialSlide = 1;
            showTutorialSlide(1);
            document.getElementById('helpModal').style.display = 'flex';
        }

        // ãƒ˜ãƒ«ãƒ—ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
        function closeHelpModal() {
            document.getElementById('helpModal').style.display = 'none';
            // åˆå›è¡¨ç¤ºæ¸ˆã¿ãƒ•ãƒ©ã‚°ã‚’ç«‹ã¦ã‚‹
            localStorage.setItem('hasSeenTutorial', 'true');
        }

        // ãƒãƒ¥ãƒ¼ãƒˆãƒªã‚¢ãƒ«ã‚¹ãƒ©ã‚¤ãƒ‰ã‚’è¡¨ç¤º
        function showTutorialSlide(slideNumber) {
            // å…¨ã‚¹ãƒ©ã‚¤ãƒ‰ã‚’éè¡¨ç¤º
            for (let i = 1; i <= 5; i++) {
                const slide = document.getElementById('tutorialSlide' + i);
                if (slide) slide.style.display = 'none';
            }
            // æŒ‡å®šã‚¹ãƒ©ã‚¤ãƒ‰ã‚’è¡¨ç¤º
            const targetSlide = document.getElementById('tutorialSlide' + slideNumber);
            if (targetSlide) targetSlide.style.display = 'block';
            currentTutorialSlide = slideNumber;
        }

        // æ¬¡ã®ã‚¹ãƒ©ã‚¤ãƒ‰ã¸
        function nextTutorialSlide() {
            if (currentTutorialSlide < 5) {
                showTutorialSlide(currentTutorialSlide + 1);
            }
        }

        // å‰ã®ã‚¹ãƒ©ã‚¤ãƒ‰ã¸
        function prevTutorialSlide() {
            if (currentTutorialSlide > 1) {
                showTutorialSlide(currentTutorialSlide - 1);
            }
        }

        // ãƒãƒ¥ãƒ¼ãƒˆãƒªã‚¢ãƒ«ã‚’ã‚¹ã‚­ãƒƒãƒ—
        function skipTutorial() {
            closeHelpModal();
        }

        // åˆå›è¡¨ç¤ºãƒã‚§ãƒƒã‚¯
        function checkFirstVisit() {
            const hasSeenTutorial = localStorage.getItem('hasSeenTutorial');
            if (!hasSeenTutorial) {
                // åˆå›è¨ªå•ãªã®ã§è‡ªå‹•ã§ãƒãƒ¥ãƒ¼ãƒˆãƒªã‚¢ãƒ«ã‚’è¡¨ç¤º
                setTimeout(() => {
                    openHelpModal();
                }, 500); // 0.5ç§’å¾Œã«è¡¨ç¤º
            }
        }

        window.onload = function() {
            loadLoanDNG();
            syncRescueTickets(); // APIè³¼å…¥åˆ†ã‚‚å«ã‚ã¦ãƒã‚±ãƒƒãƒˆæ•°ã‚’åŒæœŸ
            checkFirstVisit(); // åˆå›è¨ªå•ãƒã‚§ãƒƒã‚¯
        };

        function selectAmount(amount) {
            // ã‚»ãƒƒã‚·ãƒ§ãƒ³IDç”Ÿæˆ
            sessionID = 'SES-' + Date.now() + '-' + Math.random().toString(36).substring(2, 9);
            sessionStartTime = Date.now();
            
            if (!firstPlayDate) {
                const now = new Date();
                firstPlayDate = now.getFullYear() + '-' + 
                               String(now.getMonth() + 1).padStart(2, '0') + '-' + 
                               String(now.getDate()).padStart(2, '0');
            }
            
            gameCount++;
            gameStartLoanDNG = totalLoanDNG;
            currentDNG = amount;
            isAllInMode = false; // ã‚ªãƒ¼ãƒ«ã‚¤ãƒ³ãƒ¢ãƒ¼ãƒ‰ã‚’ãƒªã‚»ãƒƒãƒˆ
            
            if (freeDNG >= amount) {
                freeDNG -= amount;
            } else if (freeDNG > 0) {
                const needLoan = amount - freeDNG;
                freeDNG = 0;
                totalLoanDNG += needLoan;
            } else {
                totalLoanDNG += amount;
            }
            
            gameLoanDNG = totalLoanDNG;
            saveLoanDNG();
            
            document.getElementById('currentDNG').textContent = currentDNG;
            document.getElementById('totalLoanDNG').textContent = totalLoanDNG;
            document.getElementById('getTotalDNG').textContent = freeDNG;
            updateRescueTicketDisplay();
            
            switchScreen('startScreen', 'gameScreen');
            dealNewCard();
        }

        function dealNewCard() {
            currentCardValue = Math.floor(Math.random() * 13) + 1;
            currentCardSuit = suits[Math.floor(Math.random() * suits.length)];
            
            updateCardDisplay();
            updateMultiplierDisplay();
            
            const nextCardElement = document.getElementById('nextCard');
            nextCardElement.classList.add('back');
            nextCardElement.classList.remove('red', 'black');
            
            document.querySelectorAll('.game-controls button').forEach(btn => btn.disabled = false);
            
            // ã‚ªãƒ¼ãƒ«ã‚¤ãƒ³ãƒœã‚¿ãƒ³ã®æœ‰åŠ¹/ç„¡åŠ¹ã‚’åˆ¶å¾¡
            const allInBtn = document.getElementById('allInBtn');
            if (freeDNG > 0) {
                allInBtn.disabled = false;
                allInBtn.style.opacity = '1';
            } else {
                allInBtn.disabled = true;
                allInBtn.style.opacity = '0.5';
            }
            
            document.getElementById('message').textContent = 'æ¬¡ã®ã‚«ãƒ¼ãƒ‰ã¯ HIGH ã‹ LOW ã‹ï¼Ÿ';
            document.getElementById('message').className = 'message';
        }

        function updateCardDisplay() {
            const cardElement = document.getElementById('currentCard');
            const cardNumber = document.getElementById('cardNumber');
            const suitElement = cardElement.querySelector('.card-suit');
            
            cardNumber.textContent = currentCardValue;
            suitElement.textContent = currentCardSuit;
            
            if (redSuits.includes(currentCardSuit)) {
                cardElement.className = 'card red';
            } else {
                cardElement.className = 'card black';
            }
        }

        function allIn() {
            if (freeDNG <= 0) {
                alert('Get Totalã«æ®‹é«˜ãŒã‚ã‚Šã¾ã›ã‚“ã€‚\nã‚ªãƒ¼ãƒ«ã‚¤ãƒ³ã¯ã§ãã¾ã›ã‚“ã€‚');
                return;
            }
            
            if (confirm('Get Totalã® ' + freeDNG + ' DNGã‚’å…¨é¡è¿½åŠ ã—ã¦è³­ã‘ã¾ã™ã€‚\n\nHIGH ã‹ LOW ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚')) {
                // Get Totalã®DNGã‚’ç¾åœ¨ã®DNGã«è¿½åŠ 
                currentDNG += freeDNG;
                
                // Get Totalã‚’ã‚¼ãƒ­ã«ï¼ˆLoanã«ã¯è¿½åŠ ã—ãªã„ï¼è‡ªå·±è³‡é‡‘ã ã‹ã‚‰ï¼‰
                freeDNG = 0;
                
                // ä¿å­˜ã¨è¡¨ç¤ºæ›´æ–°
                saveLoanDNG();
                document.getElementById('currentDNG').textContent = currentDNG;
                document.getElementById('getTotalDNG').textContent = freeDNG;
                
                // ã‚ªãƒ¼ãƒ«ã‚¤ãƒ³ãƒ¢ãƒ¼ãƒ‰ã‚’ON
                isAllInMode = true;
                
                // ã‚ªãƒ¼ãƒ«ã‚¤ãƒ³ãƒœã‚¿ãƒ³ã‚’ç„¡åŠ¹åŒ–
                document.getElementById('allInBtn').disabled = true;
                document.getElementById('allInBtn').style.opacity = '0.5';
                
                // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸æ›´æ–°
                document.getElementById('message').innerHTML = 'ğŸ”¥ ALL INï¼å…¨è²¡ç”£ã‚’è³­ã‘ã¾ã—ãŸï¼ğŸ”¥<br>HIGH ã‹ LOW ã‚’é¸æŠã—ã¦ãã ã•ã„ï¼';
                document.getElementById('message').className = 'message result-win';
            }
        }

        function makeChoice(choice, color = null) {
            document.querySelectorAll('.game-controls button').forEach(btn => btn.disabled = true);
            document.getElementById('allInBtn').disabled = true;
            
            let nextCardValue;
            do {
                nextCardValue = Math.floor(Math.random() * 13) + 1;
            } while (nextCardValue === currentCardValue);

            const nextCardSuit = suits[Math.floor(Math.random() * suits.length)];
            
            flipNextCard(nextCardValue, nextCardSuit, choice, color);
        }

        function flipNextCard(nextCardValue, nextCardSuit, choice, color) {
            const nextCardElement = document.getElementById('nextCard');
            const nextCardNumberElement = nextCardElement.querySelector('.next-card-number');
            const nextCardSuitElement = nextCardElement.querySelector('.next-card-suit');
            
            nextCardElement.classList.add('flipping');
            
            setTimeout(() => {
                nextCardElement.classList.remove('back');
                nextCardNumberElement.textContent = nextCardValue;
                nextCardSuitElement.textContent = nextCardSuit;
                
                if (redSuits.includes(nextCardSuit)) {
                    nextCardElement.classList.remove('black');
                    nextCardElement.classList.add('red');
                } else {
                    nextCardElement.classList.remove('red');
                    nextCardElement.classList.add('black');
                }
            }, 300);
            
            setTimeout(() => {
                nextCardElement.classList.remove('flipping');
                processResult(choice, nextCardValue, nextCardSuit, color);
            }, 600);
        }

        function processResult(choice, nextCardValue, nextCardSuit, color) {
            let win = false;
            
            // æ•°å€¤ã®åˆ¤å®š
            let numberCorrect = false;
            if (choice === 'high' && nextCardValue > currentCardValue) {
                numberCorrect = true;
            } else if (choice === 'low' && nextCardValue < currentCardValue) {
                numberCorrect = true;
            }
            
            // è‰²ã®åˆ¤å®šï¼ˆè‰²æŒ‡å®šãŒã‚ã‚‹å ´åˆï¼‰
            if (color) {
                const actualColor = redSuits.includes(nextCardSuit) ? 'red' : 'black';
                win = numberCorrect && (actualColor === color);
            } else {
                win = numberCorrect;
            }

            showResult(nextCardValue, nextCardSuit, win, choice, color);
        }

        function showResult(nextValue, nextSuit, win, choice, color) {
            const messageElement = document.getElementById('message');
            
            if (win) {
                const multipliers = calculateMultipliers(currentCardValue);
                let multiplier = choice === 'high' ? multipliers.highMultiplier : multipliers.lowMultiplier;
                
                // è‰²æŒ‡å®šã®å ´åˆã¯å€ç‡ã‚’2å€ã«
                if (color) {
                    multiplier = multiplier * 2;
                }
                
                currentDNG = Math.floor(currentDNG * multiplier);
                
                if (isAllInMode) {
                    if (color) {
                        messageElement.innerHTML = 'ALL IN + è‰²çš„ä¸­ï¼<br>DNGãŒ' + multiplier.toFixed(1) + 'å€ã«ãªã‚Šã¾ã—ãŸï¼';
                    } else {
                        messageElement.innerHTML = 'ALL IN æˆåŠŸï¼<br>DNGãŒ' + multiplier.toFixed(1) + 'å€ã«ãªã‚Šã¾ã—ãŸï¼';
                    }
                    isAllInMode = false; // ã‚ªãƒ¼ãƒ«ã‚¤ãƒ³ãƒ¢ãƒ¼ãƒ‰ã‚’è§£é™¤
                } else {
                    if (color) {
                        const colorName = color === 'red' ? 'èµ¤' : 'é»’';
                        messageElement.innerHTML = 'æˆåŠŸï¼ ' + colorName + 'ã‚‚çš„ä¸­ï¼<br>DNGãŒ' + multiplier.toFixed(1) + 'å€ã«ãªã‚Šã¾ã—ãŸï¼';
                    } else {
                        messageElement.innerHTML = 'æˆåŠŸï¼<br>DNGãŒ' + multiplier.toFixed(1) + 'å€ã«ãªã‚Šã¾ã—ãŸï¼';
                    }
                }
                messageElement.className = 'message result-win';
                
                setTimeout(() => {
                    moveCardToLeft(nextValue, nextSuit);
                }, 1000);
            } else {
                currentDNG = 0;
                
                if (isAllInMode) {
                    messageElement.innerHTML = 'ALL IN å¤±æ•—...<br>å…¨è²¡ç”£ã‚’å¤±ã„ã¾ã—ãŸ...';
                    isAllInMode = false; // ã‚ªãƒ¼ãƒ«ã‚¤ãƒ³ãƒ¢ãƒ¼ãƒ‰ã‚’è§£é™¤
                } else {
                    if (color) {
                        messageElement.innerHTML = 'å¤±æ•—...<br>æ•°å€¤ã¾ãŸã¯è‰²ãŒå¤–ã‚Œã¾ã—ãŸ';
                    } else {
                        messageElement.innerHTML = 'å¤±æ•—...<br>ã™ã¹ã¦ã®DNGã‚’å¤±ã„ã¾ã—ãŸ';
                    }
                }
                messageElement.className = 'message result-lose';
                
                setTimeout(() => {
                    cashOut();
                }, 2000);
            }

            document.getElementById('currentDNG').textContent = currentDNG;
        }

        function moveCardToLeft(nextValue, nextSuit) {
            currentCardValue = nextValue;
            currentCardSuit = nextSuit;
            updateCardDisplay();
            updateMultiplierDisplay();
            
            const nextCardElement = document.getElementById('nextCard');
            nextCardElement.classList.add('back');
            nextCardElement.classList.remove('red', 'black');
            
            document.querySelectorAll('.game-controls button').forEach(btn => btn.disabled = false);
            
            // ã‚ªãƒ¼ãƒ«ã‚¤ãƒ³ãƒœã‚¿ãƒ³ã‚’å†æœ‰åŠ¹åŒ–ï¼ˆGet TotalãŒã‚ã‚‹å ´åˆã®ã¿ï¼‰
            const allInBtn = document.getElementById('allInBtn');
            if (freeDNG > 0) {
                allInBtn.disabled = false;
                allInBtn.style.opacity = '1';
            } else {
                allInBtn.disabled = true;
                allInBtn.style.opacity = '0.5';
            }
        }

        function cashOut() {
            generateTicket();
            switchScreen('gameScreen', 'ticketScreen');
        }

        function generateTicket() {
            const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
            let serial = '';
            for (let i = 0; i < 8; i++) {
                serial += chars.charAt(Math.floor(Math.random() * chars.length));
            }

            const now = new Date();
            const dateTime = now.getFullYear() + '-' + 
                           String(now.getMonth() + 1).padStart(2, '0') + '-' + 
                           String(now.getDate()).padStart(2, '0') + ' ' +
                           String(now.getHours()).padStart(2, '0') + ':' + 
                           String(now.getMinutes()).padStart(2, '0') + ':' + 
                           String(now.getSeconds()).padStart(2, '0');

            const gameProfit = currentDNG - gameLoanDNG;
            
            document.getElementById('serialNumber').textContent = serial;
            document.getElementById('finalDNG').textContent = currentDNG + ' DNG';
            document.getElementById('ticketLoanDNG').textContent = gameLoanDNG + ' DNG';
            document.getElementById('playDateTime').textContent = dateTime;

            if (gameProfit < 0) {
                const paymentAmount = Math.abs(gameProfit) * Y_RATE;
                document.getElementById('ticketConversion').textContent = paymentAmount.toLocaleString() + ' Y';
                document.getElementById('conversionRow').style.display = 'flex';
                
                document.getElementById('paymentAmount').textContent = paymentAmount.toLocaleString() + ' Y';
                document.getElementById('paymentSection').style.display = 'block';
                
                document.getElementById('restartButton').textContent = 'æ¬¡ã“ãå–ã‚Šè¿”ã™ï¼ã‚‚ã†ä¸€åº¦ã ï¼';
                
                const afterLoan = Math.max(0, gameLoanDNG - currentDNG);
                totalLoanDNG = afterLoan;
                
                document.getElementById('ticketLoanRepayment').textContent = afterLoan + ' DNG';
                document.getElementById('ticketSurplusProfit').textContent = '0 DNG';
                
                saveLoanDNG();
                
            } else {
                document.getElementById('conversionRow').style.display = 'none';
                document.getElementById('paymentSection').style.display = 'none';
                
                document.getElementById('restartButton').textContent = 'æ–°ã—ã„ã‚²ãƒ¼ãƒ ã‚’å§‹ã‚ã‚‹';
                
                const afterLoan = Math.max(0, gameLoanDNG - currentDNG);
                const surplusProfit = Math.max(0, currentDNG - gameLoanDNG);
                
                totalLoanDNG = afterLoan;
                freeDNG += surplusProfit;
                
                document.getElementById('ticketLoanRepayment').textContent = afterLoan + ' DNG';
                document.getElementById('ticketSurplusProfit').textContent = surplusProfit + ' DNG';
                
                saveLoanDNG();
            }
        }

        function resetGame() {
            currentDNG = 0;
            currentCardValue = 0;
            isAllInMode = false;
            
            const nextCardElement = document.getElementById('nextCard');
            nextCardElement.classList.add('back');
            nextCardElement.classList.remove('red', 'black');
            
            loadLoanDNG();
            switchScreen('ticketScreen', 'startScreen');
        }

        function finalSettlement() {
            const profit = freeDNG - totalLoanDNG;
            
            if (profit < 0) {
                const confirmMessage = 'ç´”ç›ŠãŒãƒã‚¤ãƒŠã‚¹ã®ãŸã‚ã€æ¸…ç®—ã§ãã¾ã›ã‚“ã€‚\n\né’ç©ºãƒ‹ã‚³ãƒ‹ã‚³ãªã£ã¡ãƒ¼é‡‘èã¸ã”æ¡ˆå†…ã—ã¾ã™ã€‚\nã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ';
                if (confirm(confirmMessage)) {
                    window.open('https://x.com/kyono_nachi', '_blank');
                }
                return;
            }
            
            const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
            let serial = '';
            for (let i = 0; i < 8; i++) {
                serial += chars.charAt(Math.floor(Math.random() * chars.length));
            }

            const now = new Date();
            const endDate = now.getFullYear() + '-' + 
                           String(now.getMonth() + 1).padStart(2, '0') + '-' + 
                           String(now.getDate()).padStart(2, '0');

            document.getElementById('finalSerial').textContent = serial;
            document.getElementById('finalGetTotal').textContent = freeDNG + ' DNG';
            document.getElementById('finalLoanTotal').textContent = totalLoanDNG + ' DNG';
            document.getElementById('finalProfit').textContent = profit + ' DNG';
            document.getElementById('finalGameCount').textContent = gameCount + 'å›';
            document.getElementById('finalPeriod').textContent = (firstPlayDate || endDate) + ' ã€œ ' + endDate;

            // ç¾åœ¨ã®ç”»é¢ã‹ã‚‰æœ€çµ‚æ¸…ç®—ç”»é¢ã¸é·ç§»
            const currentScreen = document.querySelector('.screen.active').id;
            switchScreen(currentScreen, 'finalSettlementScreen');
        }

        async function confirmFinalSettlement() {
            if (confirm('æ¸…ç®—ã‚’ç¢ºå®šã—ã¾ã™ã‹ï¼Ÿ\nDonGri Bankã«è‡ªå‹•è²¯è”µã•ã‚Œã€å…¨ãƒ‡ãƒ¼ã‚¿ãŒãƒªã‚»ãƒƒãƒˆã•ã‚Œã¾ã™ã€‚')) {
                const profit = freeDNG - totalLoanDNG;
                const uniqueID = localStorage.getItem('playerUniqueID');
                const displayName = localStorage.getItem('displayName');
                
                if (!uniqueID || !displayName) {
                    alert('ãƒãƒ¼ã‚¿ãƒ«ã‚µã‚¤ãƒˆã‹ã‚‰ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ãã ã•ã„');
                    return;
                }
                
                // è‡ªå‹•è²¯è”µå‡¦ç†
                try {
                    const response = await fetch(API_URL, {
                        method: 'POST',
                        body: JSON.stringify({
                            action: 'deposit',
                            uniqueID: uniqueID,
                            displayName: displayName,
                            gameName: 'HIGH & LOW',
                            amount: profit,
                            sessionID: sessionID,
                            timestamp: new Date().toISOString()
                        })
                    });
                    
                    const result = await response.json();
                    
                    if (result.success) {
                        // ãƒ‡ãƒ¼ã‚¿ãƒªã‚»ãƒƒãƒˆ
                        localStorage.removeItem('totalLoanDNG');
                        localStorage.removeItem('freeDNG');
                        localStorage.removeItem('gameCount');
                        localStorage.removeItem('firstPlayDate');
                        
                        totalLoanDNG = 0;
                        freeDNG = 0;
                        gameStartLoanDNG = 0;
                        gameLoanDNG = 0;
                        currentDNG = 0;
                        gameCount = 0;
                        firstPlayDate = '';
                        isAllInMode = false;
                        sessionID = '';
                        
                        document.getElementById('totalLoanDNG').textContent = '0';
                        document.getElementById('getTotalDNG').textContent = '0';
                        
                        alert('æ¸…ç®—å®Œäº†ï¼\n' + profit + ' DNGãŒDonGri Bankã«è²¯è”µã•ã‚Œã¾ã—ãŸï¼');
                        switchScreen('finalSettlementScreen', 'startScreen');
                    } else {
                        alert('è²¯è”µå‡¦ç†ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + result.message);
                    }
                } catch (error) {
                    alert('é€šä¿¡ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚ã‚‚ã†ä¸€åº¦ãŠè©¦ã—ãã ã•ã„ã€‚');
                    console.error('Error:', error);
                }
            }
        }

        function clearAllData() {
            const password = prompt('ç®¡ç†è€…ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„:');
            
            if (password !== 'DGHL') {
                alert('ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒé•ã„ã¾ã™');
                return;
            }
            
            if (confirm('å…¨ã¦ã®ãƒ‡ãƒ¼ã‚¿ï¼ˆLoan Totalã€Get Totalãªã©ï¼‰ã‚’ãƒªã‚»ãƒƒãƒˆã—ã¾ã™ã‹ï¼Ÿ')) {
                localStorage.removeItem('totalLoanDNG');
                localStorage.removeItem('freeDNG');
                localStorage.removeItem('gameCount');
                localStorage.removeItem('firstPlayDate');
                
                totalLoanDNG = 0;
                freeDNG = 0;
                gameStartLoanDNG = 0;
                gameLoanDNG = 0;
                currentDNG = 0;
                gameCount = 0;
                firstPlayDate = '';
                isAllInMode = false;
                
                document.getElementById('totalLoanDNG').textContent = '0';
                document.getElementById('getTotalDNG').textContent = '0';
                
                alert('å…¨ãƒ‡ãƒ¼ã‚¿ã‚’ãƒªã‚»ãƒƒãƒˆã—ã¾ã—ãŸ');
            }
        }

        // === ã‚«ãƒ¼ãƒ‰ãƒ‡ã‚¶ã‚¤ãƒ³è§£æ”¾æ©Ÿèƒ½ ===
        
        // åˆ©ç”¨å¯èƒ½ãªãƒ‡ã‚¶ã‚¤ãƒ³ãƒªã‚¹ãƒˆ
        const availableDesigns = [
            // åˆæœŸè§£æ”¾ãƒ‡ã‚¶ã‚¤ãƒ³ï¼ˆ5å€‹ï¼‰
            { id: 'default', name: 'åŸºæœ¬ãƒ‡ã‚¶ã‚¤ãƒ³', description: 'æ¨™æº–çš„ãªã‚´ãƒ¼ãƒ«ãƒ‰è£…é£¾ãƒ‡ã‚¶ã‚¤ãƒ³', front: 'card-pattern-1.svg', back: 'card-back.svg', unlocked: true },
            { id: 'custom_01', name: 'å·»ãä¸Šã’å¹»æµ·', description: 'ã‚·ãƒ£ãƒ³ãƒ‘ãƒ³ã‚³ãƒ¼ãƒ«ãŒå¾—æ„ãªè£…é£¾ãƒ‡ã‚¶ã‚¤ãƒ³', front: 'custom_front_01.png', back: 'custom_back_01.png', unlocked: true },
            { id: 'custom_02', name: 'ãƒ©ãƒ³ã‚¿ãƒ³å›£å­', description: 'ãƒãƒ­ã‚¦ã‚£ãƒ³ä»•æ§˜ã®ç‰¹åˆ¥ãƒ‡ã‚¶ã‚¤ãƒ³', front: 'custom_front_02.png', back: 'custom_back_02.png', unlocked: true },
            { id: 'custom_03', name: 'ãƒ™ãƒ¼ã‚«ãƒªãƒ¼ã„ã‚‹ã¯', description: 'å¤¢ã®ä¸–ç•Œã«ã®ã¿å­˜åœ¨ã™ã‚‹å¹»æƒ³ã®ãƒ‡ã‚¶ã‚¤ãƒ³', front: 'Custom_front_03.png', back: 'Custom_back_03.png', unlocked: true },
            { id: 'custom_04', name: 'æ¿€è¾›å¤§å¥½ãä¸‰ä¹—', description: 'æ„›ã™ã‚‹æ¿€è¾›ã‚’ç¾å‘³ã—ãé£Ÿã¹ã¦ã„ã‚‹ãƒ‡ã‚¶ã‚¤ãƒ³', front: 'Custom_front_04.png', back: 'Custom_back_04.png', unlocked: true },            
            // è¿½åŠ ãƒ‡ã‚¶ã‚¤ãƒ³ï¼ˆãƒã‚±ãƒƒãƒˆå¿…è¦ï¼‰
            { id: 'custom_05', name: 'ãã‚ãŒãŠäº¬é‡', description: 'ã‚¢ãƒ³ãƒ­ãƒƒã‚¯ã‚·ã‚¹ãƒ†ãƒ ã®å®Ÿé¨“ã¨ã—ã¦å­˜åœ¨ã™ã‚‹ãƒ‡ã‚¶ã‚¤ãƒ³', front: 'Custom_front_05.png', back: 'Custom_back_05.png', unlocked: false },
            { id: 'custom_06', name: '??? è¬ã®ãƒ‡ã‚¶ã‚¤ãƒ³', description: 'å®Ÿã¯é–‹æ”¾ã—ã¦ã‚‚åˆæœŸãƒ‡ã‚¶ã‚¤ãƒ³ã®ã¾ã¾ã€‚ã“ã†ã‚„ã£ã¦è¿½åŠ ã§ãã‚‹ã¨ã„ã„ã‚ˆã­', front: 'card-pattern-1.svg', back: 'card-back.svg', unlocked: false }
        ];

        // ãƒ‡ã‚¶ã‚¤ãƒ³è§£æ”¾ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‹ã
        async function openDesignUnlockModal() {
            const uniqueID = localStorage.getItem('playerUniqueID');
            if (!uniqueID) {
                alert('ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ãã ã•ã„');
                return;
            }

            // ãƒã‚±ãƒƒãƒˆæ•°ã¨è§£æ”¾æ¸ˆã¿ãƒ‡ã‚¶ã‚¤ãƒ³ã‚’å–å¾—
            try {
                const [itemsResult, designsResult] = await Promise.all([
                    fetch(API_URL, {
                        method: 'POST',
                        body: JSON.stringify({
                            action: 'getUserItems',
                            uniqueID: uniqueID
                        })
                    }).then(res => res.json()),
                    fetch(API_URL, {
                        method: 'POST',
                        body: JSON.stringify({
                            action: 'getUnlockedDesigns',
                            uniqueID: uniqueID
                        })
                    }).then(res => res.json())
                ]);

                // ãƒã‚±ãƒƒãƒˆæ•°ã‚’å–å¾—
                let ticketCount = 0;
                if (itemsResult.success && itemsResult.data.items) {
                    const ticket = itemsResult.data.items.find(item => 
                        item.itemType === 'ticket' && item.itemID === 'card_design'
                    );
                    if (ticket) ticketCount = ticket.quantity;
                }

                // è§£æ”¾æ¸ˆã¿ãƒ‡ã‚¶ã‚¤ãƒ³IDã®ãƒªã‚¹ãƒˆ
                const unlockedDesignIDs = designsResult.success && designsResult.data.designs 
                    ? designsResult.data.designs.map(d => d.designID) 
                    : [];

                // ãƒ¢ãƒ¼ãƒ€ãƒ«ã«è¡¨ç¤º
                document.getElementById('modalTicketCount').textContent = ticketCount;
                displayDesignGrid(unlockedDesignIDs, ticketCount);
                document.getElementById('designUnlockModal').style.display = 'flex';
            } catch (error) {
                console.error('Error loading design data:', error);
                alert('ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ');
            }
        }

        // ãƒ‡ã‚¶ã‚¤ãƒ³ã‚°ãƒªãƒƒãƒ‰è¡¨ç¤º
        function displayDesignGrid(unlockedDesignIDs, ticketCount) {
            const grid = document.getElementById('designGrid');
            const currentDesign = localStorage.getItem('cardDesign') || 'default';
            let html = '';

            availableDesigns.forEach(design => {
                // åˆæœŸè§£æ”¾ãƒ‡ã‚¶ã‚¤ãƒ³ã¾ãŸã¯DBã§è§£æ”¾æ¸ˆã¿
                const isUnlocked = design.unlocked || unlockedDesignIDs.includes(design.id);
                const canUnlock = !isUnlocked && ticketCount > 0;
                const isCurrentDesign = currentDesign === design.id;

                html += `
                    <div style="
                        border: 2px solid ${isCurrentDesign ? '#FFD700' : isUnlocked ? '#4CAF50' : 'rgba(212, 175, 55, 0.3)'};
                        border-radius: 12px;
                        padding: 20px;
                        margin-bottom: 15px;
                        background: ${isCurrentDesign ? 'rgba(255, 215, 0, 0.1)' : 'rgba(255, 255, 255, 0.05)'};
                    ">
                        <!-- ãƒ‡ã‚¶ã‚¤ãƒ³å -->
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                            <div>
                                <div style="font-size: 1.1em; color: #d4af37; font-weight: bold; margin-bottom: 5px;">
                                    ${design.name}
                                </div>
                                <div style="font-size: 0.85em; color: #aaa;">
                                    ${design.description}
                                </div>
                            </div>
                            ${isCurrentDesign ? '<div style="color: #FFD700; font-size: 1.2em;">â˜…</div>' : ''}
                        </div>

                        <!-- è¡¨è£ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ -->
                        <div style="display: flex; gap: 15px; margin-bottom: 15px; justify-content: center;">
                            ${isUnlocked ? `
                                <div style="text-align: center;">
                                    <div style="font-size: 0.8em; color: #888; margin-bottom: 5px;">è¡¨é¢</div>
                                    <img src="images/${design.front}" style="width: 90px; height: auto; border-radius: 8px; box-shadow: 0 3px 10px rgba(0,0,0,0.4);">
                                </div>
                                <div style="text-align: center;">
                                    <div style="font-size: 0.8em; color: #888; margin-bottom: 5px;">è£é¢</div>
                                    <img src="images/${design.back}" style="width: 90px; height: auto; border-radius: 8px; box-shadow: 0 3px 10px rgba(0,0,0,0.4);">
                                </div>
                            ` : `
                                <div style="text-align: center; position: relative;">
                                    <div style="font-size: 0.8em; color: #888; margin-bottom: 5px;">è¡¨é¢</div>
                                    <div style="position: relative;">
                                        <img src="images/${design.front}" style="width: 90px; height: auto; border-radius: 8px; opacity: 0.3; filter: grayscale(50%);">
                                        <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: 2em;">ğŸ”’</div>
                                    </div>
                                </div>
                                <div style="text-align: center; position: relative;">
                                    <div style="font-size: 0.8em; color: #888; margin-bottom: 5px;">è£é¢</div>
                                    <div style="position: relative;">
                                        <img src="images/${design.back}" style="width: 90px; height: auto; border-radius: 8px; opacity: 0.3; filter: grayscale(50%);">
                                        <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: 2em;">ğŸ”’</div>
                                    </div>
                                </div>
                            `}
                        </div>

                        <!-- ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãƒœã‚¿ãƒ³ -->
                        <div style="text-align: center;">
                            ${isCurrentDesign
                                ? '<div style="color: #FFD700; font-size: 0.9em; font-weight: bold;">â˜… ä½¿ç”¨ä¸­</div>'
                                : isUnlocked 
                                    ? `<button class="btn btn-small" onclick="selectDesign('${design.id}')" style="padding: 10px 20px; background: rgba(76, 175, 80, 0.2); color: #4CAF50; border: 1px solid #4CAF50;">ã“ã®ãƒ‡ã‚¶ã‚¤ãƒ³ã‚’é¸æŠ</button>` 
                                    : canUnlock 
                                        ? `<button class="btn btn-small" onclick="unlockDesign('${design.id}')" style="padding: 10px 20px;">ğŸ« ãƒã‚±ãƒƒãƒˆã§è§£æ”¾ã™ã‚‹</button>`
                                        : '<div style="color: #888; font-size: 0.9em;">ğŸ”’ ãƒã‚±ãƒƒãƒˆãŒå¿…è¦ã§ã™</div>'
                            }
                        </div>
                    </div>
                `;
            });

            grid.innerHTML = html;
            
            // ç¾åœ¨ã®ãƒ‡ã‚¶ã‚¤ãƒ³åã‚’æ›´æ–°
            const currentDesignObj = availableDesigns.find(d => d.id === currentDesign);
            if (currentDesignObj) {
                document.getElementById('currentDesignName').textContent = currentDesignObj.name;
            }
        }

        // ãƒ‡ã‚¶ã‚¤ãƒ³è§£æ”¾å®Ÿè¡Œ
        async function unlockDesign(designID) {
            const uniqueID = localStorage.getItem('playerUniqueID');
            if (!uniqueID) return;

            if (!confirm('ãƒã‚±ãƒƒãƒˆ1æšã‚’æ¶ˆè²»ã—ã¦ã“ã®ãƒ‡ã‚¶ã‚¤ãƒ³ã‚’è§£æ”¾ã—ã¾ã™ã‹?')) {
                return;
            }

            try {
                const response = await fetch(API_URL, {
                    method: 'POST',
                    body: JSON.stringify({
                        action: 'unlockDesign',
                        uniqueID: uniqueID,
                        designID: designID
                    })
                });

                const result = await response.json();

                if (result.success) {
                    alert('ãƒ‡ã‚¶ã‚¤ãƒ³ã‚’è§£æ”¾ã—ã¾ã—ãŸ!');
                    // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’å†èª­ã¿è¾¼ã¿
                    closeDesignUnlockModal();
                    openDesignUnlockModal();
                } else {
                    alert('è§£æ”¾ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + result.message);
                }
            } catch (error) {
                console.error('Error unlocking design:', error);
                alert('é€šä¿¡ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ');
            }
        }

        // ãƒ‡ã‚¶ã‚¤ãƒ³è§£æ”¾ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
        function closeDesignUnlockModal() {
            document.getElementById('designUnlockModal').style.display = 'none';
        }

        // ãƒ‡ã‚¶ã‚¤ãƒ³ã‚’é¸æŠ
        function selectDesign(designID) {
            const design = availableDesigns.find(d => d.id === designID);
            if (!design) return;

            // localStorageã«ä¿å­˜
            localStorage.setItem('cardDesign', designID);
            
            // ã‚«ãƒ¼ãƒ‰ãƒ‡ã‚¶ã‚¤ãƒ³ã‚’é©ç”¨
            applyCardDesignFromAvailable(design);
            
            // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’å†æç”»
            const uniqueID = localStorage.getItem('playerUniqueID');
            if (uniqueID) {
                // ç¾åœ¨ã®çŠ¶æ…‹ã§å†æç”»
                fetch(API_URL, {
                    method: 'POST',
                    body: JSON.stringify({
                        action: 'getUnlockedDesigns',
                        uniqueID: uniqueID
                    })
                })
                .then(res => res.json())
                .then(result => {
                    const unlockedDesignIDs = result.success && result.data.designs 
                        ? result.data.designs.map(d => d.designID) 
                        : [];
                    const ticketCount = parseInt(document.getElementById('modalTicketCount').textContent) || 0;
                    displayDesignGrid(unlockedDesignIDs, ticketCount);
                });
            }
        }

        // æ–°ã—ã„ãƒ‡ã‚¶ã‚¤ãƒ³ã‚·ã‚¹ãƒ†ãƒ ã®ã‚«ãƒ¼ãƒ‰é©ç”¨
        function applyCardDesignFromAvailable(design) {
            const style = document.createElement('style');
            style.id = 'dynamic-card-style';
            
            // æ—¢å­˜ã®ã‚¹ã‚¿ã‚¤ãƒ«ã‚’å‰Šé™¤
            const existingStyle = document.getElementById('dynamic-card-style');
            if (existingStyle) {
                existingStyle.remove();
            }

            style.innerHTML = `
                .card:not(.back) {
                    background-image: url('images/${design.front}') !important;
                }
                .card.back {
                    background-image: url('images/${design.back}') !important;
                }
            `;
            
            document.head.appendChild(style);
        }

        function switchScreen(fromId, toId) {
            document.getElementById(fromId).classList.remove('active');
            document.getElementById(toId).classList.add('active');
        }

        window.addEventListener('DOMContentLoaded', function() {
            loadLoanDNG();
            loadCardDesign(); // ã‚«ãƒ¼ãƒ‰ãƒ‡ã‚¶ã‚¤ãƒ³ã‚’èª­ã¿è¾¼ã¿
            
            const nextCardElement = document.getElementById('nextCard');
            if (nextCardElement) {
                nextCardElement.classList.add('back');
                nextCardElement.classList.remove('red', 'black');
            }
        });
    </script>
</body>
</html>
